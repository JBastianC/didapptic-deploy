<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="fav/favicon-2.png">

<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planificación Didáctica</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    margin: 0;
    padding: 20px;
    background-color: #f9f9f9;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background-color: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  h1, h2, h3 {
    color: #2c3e50;
    margin-top: 30px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
  }
  th, td {
    border: 1.5px solid #333;
    padding: 12px;
    text-align: center;
    vertical-align: middle;
  }
  td.momento {
    min-width: 110px;
    max-width: 220px;
    width: 220px;
    overflow: visible;
    word-break: break-word;
  }
  td.momento textarea {
    width: 100%;
    min-height: 38px;
    max-width: 100%;
    resize: none;
    overflow-x: hidden;
    box-sizing: border-box;
    font-size: 14px;
    line-height: 1.2;
    display: block;
    transition: height 0.1s;
  }
  td.momento textarea.auto-grow {
    overflow-y: hidden;
  }
  td.momento div {
    display: flex;
    align-items: flex-start;
    gap: 4px;
  }
  td.momento button {
    padding: 0 6px;
    font-size: 18px;
    line-height: 1;
    background: none;
    border: none;
    cursor: pointer;
  }
  #evaluacionTable th, #evaluacionTable td {
    border: 1.5px solid #333;
    text-align: center;
    vertical-align: middle;
  }
  #evaluacionTable .editable {
    text-align: justify;
    vertical-align: middle;
  }
  th {
    background-color: #f2f2f2;
    font-weight: bold;
  }
  .editable {
    min-height: 20px;
    padding: 8px;
    border: 1px dashed transparent;
  }
  .editable:hover {
    border-color: #ccc;
  }
  .editable:focus {
    outline: none;
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  .toolbar {
    background: #f8f9fa;
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 5px;
    display: flex;
    gap: 10px;
  }
  .toolbar button {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .toolbar button:hover {
    background: #0056b3;
  }
  .logo-container {
    text-align: center;
    margin: 20px 0;
  }
  .logo-img {
    width: 120px;
    height: 90px;
    object-fit: contain;
    border-radius: 0;
    border: none;
    background: #f4f4f4;
    display: block;
    margin: 0 auto;
    box-shadow: none;
  }
  footer {
    margin-top: 40px;
    text-align: center;
    font-size: 14px;
    color: #666;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }
  .print-mode {
    width: 21.59cm;
    margin: 0 auto;
    padding: 1cm;
    background-color: white;
    box-shadow: none;
  }
  .print-mode .container {
    max-width: 100%;
    padding: 0;
    box-shadow: none;
  }
  .print-mode .toolbar {
    display: none;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 900px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    max-height: 80vh;
    overflow: hidden;
  }
  .alumnos-table-scroll {
    flex: 1 1 auto;
    overflow-y: auto;
    margin-bottom: 16px;
    max-height: 50vh;
  }
  .alumnos-modal-footer {
    flex-shrink: 0;
    background: #fff;
    padding-top: 12px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    position: sticky;
    bottom: 0;
    z-index: 2;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover {
    color: black;
  }
  .alumnos-table {
    width: 100%;
    margin-bottom: 20px;
  }
  .alumnos-table th {
    background-color: #4CAF50;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .alumnos-table td {
    vertical-align: middle;
  }
  .radio-selected {
    background-color: #d4edda;
  }
  .chart-container {
    width: 100%;
    height: 400px;
    margin-top: 30px;
  }
  .add-alumnos-btn {
    margin: 10px 0;
    padding: 10px 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .add-alumnos-btn:hover {
    background-color: #218838;
  }
  .file-input {
    display: none;
  }
  .btn-import {
    padding: 10px 15px;
    background-color: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
  }
  .btn-import:hover {
    background-color: #138496;
  }
  .btn-download {
    padding: 10px 15px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
  }
  .btn-download:hover {
    background-color: #5a6268;
  }
  .btn-yellow {
    padding: 10px 15px;
    background-color: #ffe066;
    color: #333;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
    font-weight: bold;
    box-shadow: 0 1px 2px #0001;
    transition: background 0.2s;
  }
  .btn-yellow:hover {
    background-color: #ffd43b;
    color: #222;
  }
  .load-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .load-modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .load-options {
    margin: 20px 0;
  }
  .load-option {
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
  }
  .load-option:hover {
    background-color: #f0f0f0;
  }
  .verb {
    font-weight: bold;
    color: #2c3e50;
  }
  .table-item {
    margin: 5px 0;
    padding: 5px;
    border-bottom: 1px solid #eee;
  }
.nivel-logro-def {
  font-size: 0.85em;
  background: #f2f2f2;
  color: #00bb67;
  border-radius: 4px;
  padding: 4px 6px;
  font-weight: 500;
  box-shadow: 0 1px 3px #0001;
  border: 1.5px solid #e0e0e0;
  margin: 2px;
}
.bordered-black {
  border: 2px solid #111 !important;
}
  @media print {
  body.hide-estrategia-print th.estrategia-col,
  body.hide-estrategia-print td.estrategia-col {
    display: none !important;
  }
  body.hide-estrategia-print th.actividades-col,
  body.hide-estrategia-print td.actividades-col {
    width: 100% !important;
    max-width: 100% !important;
  }

    /* Hide specific buttons in print mode */
    .add-alumnos-btn, /* + Añadir Alumnos */
    .add-row-btn,     /* Añadir Fila */
    .reciclar-btn,    /* ♻️ button, assuming this class is used */
    button[data-print-hide], /* fallback for any button marked for print hiding */
    .toolbar,         /* Toolbar section */
    .floating-btn {
      display: none !important;
    }

    /* Hide Estrategia column ONLY if it has the print-only class */
    #secuenciaTable th.no-print-estrategia,
    #secuenciaTable td.no-print-estrategia {
      display: none !important;
    }
    /* Hide select dropdowns and toggle button in Estrategia column in print */
    #secuenciaTable td.estrategia-col select,
    #secuenciaTable th.estrategia-col button {
      display: none !important;
    }
    /* Expand Actividades column only if it has the special expanded class */
    #secuenciaTable th.actividades-expandida,
    #secuenciaTable td.actividades-expandida {
      width: 100% !important;
      max-width: 100% !important;
    }
  }
</style>
</head>
  <script src="creditos-api.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', async function() {
    if (typeof getCreditosUsuario === 'function' && typeof isPremiumUser === 'function') {
      if (isPremiumUser()) {
        try {
          const creditos = await getCreditosUsuario();
          window.actualizarCreditosScore(creditos);
        } catch(e) {
          const scoreDiv = document.getElementById('creditos-score');
          if (scoreDiv) scoreDiv.textContent = 'Créditos: ?';
        }
      } else {
        document.getElementById('creditos-score').style.display = 'none';
      }
    }
  });
</script>
<body>
<div class="container">
  <div class="toolbar">
    <button onclick="exportPlanJSON()">Guardar Plan</button>
    <button onclick="togglePrintMode()">Modo Impresión</button>
    <button onclick="document.getElementById('planFileInput').click()">Cargar Plan</button>
    <input type="file" id="planFileInput" accept="application/json" style="display:none;" onchange="importPlanJSON(event)">
    <div id="creditos-score" style="display:none; margin-left: 16px; font-weight: bold; color: #3483FA;"></div>
  </div>

  <div class="logo-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <!-- Left Logo Upload -->
  <div class="logo-container" style="flex: 0 0 auto;">
    <label for="logoInputLeft" style="cursor:pointer;display:inline-block;">
      <img id="customLogoLeft" src="assets/Ddapptic.svg" alt="Logo Izquierdo" class="logo-img">
    </label>
    <input type="file" id="logoInputLeft" accept="image/*" style="display:none;">
  </div>
  <!-- Center Date -->
  <div style="flex: 1 1 auto; text-align: center;">
    <p id="currentDate" class="editable" contenteditable="true" style="margin: 0;"></p>
  </div>
  <!-- Right Logo Upload -->
  <div class="logo-container" style="flex: 0 0 auto;">
    <label for="logoInputRight" style="cursor:pointer;display:inline-block;">
      <img id="customLogoRight" src="assets/Ddapptic.svg" alt="Logo Derecho" class="logo-img">
    </label>
    <input type="file" id="logoInputRight" accept="image/*" style="display:none;">
  </div>
  
</div>

  <h1>Datos Generales</h1>
  <table style="border-collapse:collapse;">
    <tr>
      <th style="border:1.5px solid #333;">Nivel Educativo</th>
      <td id="nivelEducativo" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
      <th style="border:1.5px solid #333;">Nombre del Centro</th>
      <td id="centroTrabajo" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
    </tr>
    <tr>
      <th style="border:1.5px solid #333;">Sector Educativo</th>
      <td id="sectorEducativo" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
      <th style="border:1.5px solid #333;">Zona Escolar</th>
      <td id="zonaEscolar" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
    </tr>
    <tr>
      <th style="border:1.5px solid #333;">Fase</th>
      <td id="fase" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
      <th style="border:1.5px solid #333;">Grado</th>
      <td id="grado" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
    </tr>
    <tr>
      <th style="border:1.5px solid #333;">Grupo</th>
      <td id="grupo" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
      <th style="border:1.5px solid #333;">Nombre del Docente</th>
      <td id="nombreDocente" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
    </tr>
    <tr>
      <th style="border:1.5px solid #333;">Nombre del Director</th>
      <td id="nombreDirector" class="editable" contenteditable="true" style="border:1.5px solid #333;"></td>
      <th style="border:1.5px solid #333;">Periodo de realización</th>
      <td style="border:1.5px solid #333;"><span id="inicioPeriodo" class="editable" contenteditable="true"></span> al <span id="finPeriodo" class="editable" contenteditable="true"></span></td>
    </tr>
  </table>


  <div style="display:none">
    <h2>planViewerData (JSON crudo)</h2>
    <textarea id="planViewerDataRaw" readonly style="width:100%;height:150px;font-family:monospace;"></textarea>
  </div>
  
  <h1>Ubicación Curricular</h1>
  <style>
#ubicacionTable td, #ubicacionTable th {
  vertical-align: middle !important;
}
</style>
<table id="ubicacionTable">
    <thead>
      <tr>
        <th>Problema</th>
        <th>Campo(s) Formativo(s)</th>
        <th>Contenido(s)</th>
        <th>PDA(s)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Las filas se llenan automáticamente por JS -->
    </tbody>
  </table>


  <h1>Evaluación</h1>
  <div id="evaluacionTableContainer"></div>
<script>
function crearTablaEvaluacionOrdenada() {
  // 1. Extraer PDAs desde la estructura jerárquica de planViewerData.ubicacion si existe
  let pdaSet = new Set();
  let pdaList = [];
  let planViewerData = null;
  try {
    planViewerData = JSON.parse(localStorage.getItem('planViewerData'));
  } catch (e) { planViewerData = null; }
  if (planViewerData && Array.isArray(planViewerData.ubicacion)) {
    planViewerData.ubicacion.forEach(item => {
      if (item.contenidos && Array.isArray(item.contenidos)) {
        item.contenidos.forEach(contenidoObj => {
          if (contenidoObj.pdas && Array.isArray(contenidoObj.pdas)) {
            contenidoObj.pdas.forEach(pda => {
              const trimmed = (pda||'').trim();
              if (trimmed && !pdaSet.has(trimmed)) {
                pdaList.push(trimmed);
                pdaSet.add(trimmed);
              }
            });
          }
        });
      }
    });
  }
  // Si no hay PDAs en la estructura, usar el mecanismo anterior como respaldo
  if (pdaList.length === 0) {
    const ubicacionTable = document.getElementById('ubicacionTable');
    if (ubicacionTable) {
      for (let i = 1; i < ubicacionTable.rows.length; i++) { // Saltar encabezado
        const pdaCell = ubicacionTable.rows[i].cells[3];
        if (pdaCell && pdaCell.textContent.trim()) {
          pdaCell.textContent.split(/[#;\n]/).forEach(pda => {
            const trimmed = pda.trim();
            if (trimmed && !pdaSet.has(trimmed)) {
              pdaList.push(trimmed);
              pdaSet.add(trimmed);
            }
          });
        }
      }
    }
  }

  // 3. Crear tabla HTML dinámica
  let tableHtml = '';
  // Nueva tabla de Evaluación con columna PDA(s)
  tableHtml += '<table id="evaluacionTable">';
  tableHtml += '<tr><th colspan="7">Nivel de logro</th></tr>';
  tableHtml += '<tr>';
  tableHtml += '<th rowspan="2">PDA(s)</th>';
  bloomLevels.forEach(lvl => tableHtml += `<th>${lvl.name}</th>`);
  tableHtml += '</tr>';
  tableHtml += '<tr>';
  tableHtml += `<td class="nivel-logro-def">Uso y dominio de la memoria a largo plazo</td>`;
  tableHtml += `<td class="nivel-logro-def">Comprensión de las ideas y de los conceptos</td>`;
  tableHtml += `<td class="nivel-logro-def">Capacidad de fragmentar la información, descomponerla y relacionarla.</td>`;
  tableHtml += `<td class="nivel-logro-def">Capacidad de fragmentar la información, descomponerla y relacionarla.</td>`;
  tableHtml += `<td class="nivel-logro-def">Emitir juicios de valor, justificar y defender opiniones</td>`;
  tableHtml += `<td class="nivel-logro-def">Utilizar lo aprendido y las habilidades adquiridas para construir ideas nuevas.</td>`;
  tableHtml += '</tr>';

  // --- Lematización y resaltado de verbos de Bloom ---
  // Diccionario simple para lematizar (puedes expandirlo)

  // Verbos por nivel de Bloom
  const bloomLevelsArr = [
    {name: 'Recordar', verbs: verbosPorNivel.recordar.concat(['reconocer', 'reconoce', 'reconocen', 'reconoció', 'reconocieron'])},
    {name: 'Comprender', verbs: verbosPorNivel.comprender},
    {name: 'Analizar', verbs: verbosPorNivel.analizar.concat(['explorar', 'explora', 'exploran', 'exploró', 'exploraron'])},
    {name: 'Aplicar', verbs: verbosPorNivel.aplicar},
    {name: 'Valorar', verbs: verbosPorNivel.valorar.concat(['compartir', 'comparte', 'comparten', 'compartió', 'compartieron'])},
    {name: 'Crear', verbs: verbosPorNivel.crear}
  ];
  // Función findBloomVerb eliminada: toda la lógica de comparación y lematización se centraliza en getBloomLevelsAndHighlight y lemmatize.


  // Función para escapar HTML
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // --- Analizar y resaltar todos los verbos de Bloom en cada PDA ---
  // (ELIMINADA: ahora se usa getBloomLevelsAndHighlight para todo PDA)


  // Estado de ubicación de PDAs
  let ubicados = JSON.parse(localStorage.getItem('evaluacionUbicados')||'{}');

  // Convertir todos los PDA a minúsculas para evitar conflictos
  pdaList = pdaList.map(pda => pda.toLowerCase());

  // Renderizar tabla usando los PDAs ya analizados
  let pdaAnalizados = pdaList.map((pda, idx) => {
    // Escapa el texto ANTES de resaltar
    let safeText = escapeHtml(pda);
    const { levels, html } = getBloomLevelsAndHighlight(safeText, idx);
    let nivelIdx = levels && levels.length > 0 ? bloomLevels.findIndex(lvl => lvl.name === levels[0]) : -1;
    let nivel = levels && levels.length > 0 ? levels[0] : null;
    return { original: pda, highlighted: html, nivelIdx, nivel };
  });
  pdaAnalizados.forEach((row, idx) => {
    tableHtml += '<tr>';
    // Si el PDA ya fue ubicado, mostrarlo en gris y permitir reset con click derecho
    if (ubicados[idx] && ubicados[idx].nivel >= 0) {
      tableHtml += `<td style="color:#888;cursor:pointer;" class="pda-ubicado" data-pda-idx="${idx}">${row.highlighted}</td>`;
    } else {
      tableHtml += `<td>${row.highlighted}</td>`;
    }
    for (let c = 0; c < 6; c++) {
      if (ubicados[idx] && ubicados[idx].nivel === c) {
        tableHtml += `<td style="position:relative;"><span style="font-weight:bold;color:#222;">${row.original}</span><button class="remove-pda-btn" data-pda-idx="${idx}" title="Quitar ubicación" style="position:absolute;top:4px;right:4px;width:20px;height:20px;background:#eee;border:1px solid #aaa;border-radius:50%;cursor:pointer;font-weight:bold;line-height:16px;padding:0;">&#10006;</button></td>`;
      } else {
        tableHtml += '<td></td>';
      }
    }
    tableHtml += '</tr>';
  });

  tableHtml += '</table>';
  document.getElementById('evaluacionTableContainer').innerHTML = tableHtml;

  // Interactividad: click en verbo destacado (negrita verde)
  document.querySelectorAll('.bloom-verb-clickable').forEach(el => {
    el.addEventListener('click', function(e) {
      const idx = parseInt(this.getAttribute('data-pda-idx'));
      const nivelName = this.getAttribute('data-nivel');
      let nivel = bloomLevels.findIndex(lvl => lvl.name === nivelName);
// Si no se encontró el nivel por nombre, buscar por verbo lematizado
if (nivel < 0 && this.hasAttribute('data-verb')) {
  const verbo = this.getAttribute('data-verb').toLowerCase();
  const lemma = lemmatize(verbo);
  for (let i = 0; i < bloomLevels.length; i++) {
    if (bloomLevels[i].verbs.includes(lemma)) {
      nivel = i;
      break;
    }
  }
}
      // Guardar ubicación
      ubicados[idx] = {nivel};
      localStorage.setItem('evaluacionUbicados', JSON.stringify(ubicados));
      // Feedback visual
      this.style.background = '#ffe066';
      // Volver a renderizar para actualizar la tabla
      crearTablaEvaluacionOrdenada();
    });
  });
  // Interactividad: botón para quitar ubicación
  document.querySelectorAll('.remove-pda-btn').forEach(el => {
    el.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.getAttribute('data-pda-idx'));
      delete ubicados[idx];
      localStorage.setItem('evaluacionUbicados', JSON.stringify(ubicados));
      crearTablaEvaluacionOrdenada();
    });
  });
  // Interactividad: click derecho para resetear ubicación (opcional, sigue disponible)
  document.querySelectorAll('.pda-ubicado').forEach(el => {
    el.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      const idx = parseInt(this.getAttribute('data-pda-idx'));
      delete ubicados[idx];
      localStorage.setItem('evaluacionUbicados', JSON.stringify(ubicados));
      crearTablaEvaluacionOrdenada();
    });
  });
}





// Ejecutar al cargar y cada vez que cambien los PDAs
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(crearTablaEvaluacionOrdenada, 500);
});
// Si tienes un evento donde se actualiza la tabla de PDAs, llama también a crearTablaEvaluacionOrdenada();
</script>
  
  
  <div id="chartContainer" class="chart-container" style="display: none;">
    <h3>Aprovechamiento General</h3>
    <canvas id="logroChart"></canvas>
  </div>

  <button id="addAlumnosBtn" class="add-alumnos-btn" onclick="openAlumnosModal()">+ Añadir Alumnos</button>

  <h1>Secuencia Didáctica</h1>
  <table>
  <tr>
    <th>Nombre del proyecto</th>
    <td id="nombreProyecto" class="bordered-black no-edit" style="background:#f5f5f5;cursor:default;" tabindex="-1"></td>
  </tr>
  <tr>
    <th>Metodología/Estrategia</th>
    <td id="metodologia" class="bordered-black no-edit" style="background:#f5f5f5;cursor:default;" tabindex="-1"></td>
  </tr>
</table>
  <div id="secuenciaTableContainer"></div>

  <h1>Organización</h1>
  <table id="organizacionTable">
    <thead>
      <tr>
        <th>Fase</th>
        <th id="etapaHeader" style="display:none;">Etapa</th>
        <th>Tiempo (min)</th>
        <th>Espacio</th>
        <th>Medios</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="organizacionTableBody">
      <!-- Rows will be dynamically inserted -->
    </tbody>
  </table>
  <button id="addOrganizacionRowBtn" class="add-alumnos-btn">+ Añadir Fila</button>
  <div id="recycleMediosMenu" style="display:none;position:absolute;background:#fff;border:1px solid #ccc;z-index:2000;"></div>

</div>

<!-- MODAL DE ALUMNOS -->
<div id="alumnosModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAlumnosModal()">&times;</span>
    <h2>Lista de Alumnos</h2>
    <div class="alumnos-table-scroll" style="max-height:320px;overflow-y:auto;">
      <table class="alumnos-table" style="width:100%;margin-bottom:20px;">
        <thead style="position: sticky; top: 0; background-color: white;">
          <tr>
            <th>Nombre</th>
            <th>Recordar</th>
            <th>Comprender</th>
            <th>Analizar</th>
            <th>Aplicar</th>
            <th>Valorar</th>
            <th>Crear</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="alumnosTableBody">
          <!-- Filas de alumnos se llenan por JS -->
        </tbody>
      </table>
    </div>
    <div class="alumnos-modal-footer">
      <button class="btn-import" onclick="document.getElementById('excelInput').click()">Importar Excel</button>
      <input type="file" id="excelInput" class="file-input" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelImport(event)">
      <button class="btn-download" onclick="downloadExcelTemplate()">Descargar Formato</button>
      <button class="btn-yellow" id="addAlumnoBtn" onclick="addNewAlumno()">Añadir Alumno</button>
      <button class="btn-yellow" id="saveAlumnosBtn" onclick="saveAlumnosData()">Guardar</button>
      <button class="btn-yellow" onclick="closeAlumnosModal()">Cerrar</button>
    </div>
  </div>
</div>

<div id="loadModal" class="load-modal">
  <div class="load-modal-content">
    <span class="close">&times;</span>
    <h2>Cargar Datos</h2>
    <div class="load-options">
      <div class="load-option" onclick="loadFromLocalStorage()">
        <h3>Cargar desde almacenamiento local</h3>
        <p>Recupera los datos guardados anteriormente en este navegador</p>
      </div>
      <div class="load-option" onclick="loadFromCanvasData()">
        <h3>Cargar desde datos del canvas</h3>
        <p>Importa los datos generados en el plano didáctico</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="creditos-api.js"></script>
<script>
// Logo personalizado (izquierdo y derecho)
window.addEventListener('DOMContentLoaded', function() {
  // Left logo
  const logoInputLeft = document.getElementById('logoInputLeft');
  const customLogoLeft = document.getElementById('customLogoLeft');
  if (logoInputLeft && customLogoLeft) {
    logoInputLeft.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          customLogoLeft.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    customLogoLeft.onclick = function() {
      logoInputLeft.click();
    };
  }
  // Right logo
  const logoInputRight = document.getElementById('logoInputRight');
  const customLogoRight = document.getElementById('customLogoRight');
  if (logoInputRight && customLogoRight) {
    logoInputRight.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          customLogoRight.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    customLogoRight.onclick = function() {
      logoInputRight.click();
    };
  }
});
  // Variables globales
  let alumnosData = [];
  let logroChart = null;
  let canvasData = null;
  const verbosPorNivel = {
    recordar: [
      'recordar', 'reconocer', 'reconoce', 'reconocen', 'reconoció', 'reconocieron', 'identificar', 'nombrar', 'definir', 'repetir', 'listar', 'describir', 'señalar', 'enumerar', 'ubicar', 'etiquetar', 'emparejar', 'reproducir', 'seleccionar', 'recitar'
    ],
    comprender: [
      'aprender', 'aprende', 'aprenden', 'aprendió', 'aprendieron', 'explicar', 'resumir', 'interpretar', 'comparar', 'clasificar', 'parafrasear', 'ilustrar', 'predecir', 'discutir', 'estimar', 'inferir', 'traducir', 'ejemplificar', 'expresar', 'reorganizar', 'ordenar', 'mostrar'
    ],
    aplicar: [
      'aplicar', 'usar', 'implementar', 'resolver', 'demostrar', 'practicar', 'ejecutar', 'operar', 'construir', 'calcular', 'manipular', 'desarrollar', 'modificar', 'modelar', 'emplear', 'experimentar', 'dramatizar'
    ],
    analizar: [
      'analizar', 'explorar', 'explora', 'exploran', 'exploró', 'exploraron', 'diferenciar', 'organizar', 'comparar', 'contrastar', 'examinar', 'categorizar', 'identificar', 'relacionar', 'separar', 'investigar', 'distinguir', 'descomponer', 'encontrar evidencia', 'aislar', 'estructurar', 'mapear'
    ],
    valorar: [
      'evaluar', 'compartir', 'comparte', 'comparten', 'compartió', 'compartieron', 'juzgar', 'justificar', 'criticar', 'defender', 'concluir', 'determinar', 'argumentar', 'valorar', 'recomendar', 'seleccionar', 'verificar', 'validar', 'calificar', 'priorizar', 'decidir', 'reflexionar'
    ],
    crear: [
      'crear', 'diseñar', 'construir', 'planificar', 'inventar', 'proponer', 'desarrollar', 'generar', 'formular', 'elaborar', 'idear', 'componer', 'escribir', 'organizar', 'reestructurar', 'integrar', 'modificar', 'mezclar', 'combinar'
    ]
  };




  // Función para cargar datos del usuario
  async function loadUserData() {
    const userData = JSON.parse(localStorage.getItem('userData'));
    if (!userData) return;

    try {
      const response = await fetch('/api/config', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      if (!response.ok) throw new Error('Error al cargar configuración');
      
      const data = await response.json();
      
      if (data.success && data.config) {
        document.getElementById('nivelEducativo').textContent = data.config.nivelEducativo || '';
        document.getElementById('centroTrabajo').textContent = data.config.centroTrabajo || '';
        document.getElementById('sectorEducativo').textContent = data.config.sectorEducativo || '';
        document.getElementById('zonaEscolar').textContent = data.config.zonaEscolar || '';
        document.getElementById('fase').textContent = data.config.fase || '';
        document.getElementById('grado').textContent = data.config.grado || '';
        document.getElementById('grupo').textContent = data.config.grupo || '';
        document.getElementById('nombreDocente').textContent = data.config.nombreDocente || '';
        document.getElementById('nombreDirector').textContent = data.config.nombreDirector || '';
        document.getElementById('inicioPeriodo').textContent = data.config.inicioPeriodo || '';
        document.getElementById('finPeriodo').textContent = data.config.finPeriodo || '';
        
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-MX', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      }
    } catch (error) {
      console.error('Error al cargar configuración:', error);
    }

    // Cargar datos guardados
    const savedAlumnos = localStorage.getItem('alumnosData');
    if (savedAlumnos) alumnosData = JSON.parse(savedAlumnos);

    const savedTables = localStorage.getItem('tablesData');
    if (savedTables) loadTablesData(JSON.parse(savedTables));

    const savedCanvasData = localStorage.getItem('canvasData');
    if (savedCanvasData) {
      canvasData = JSON.parse(savedCanvasData);
      loadCanvasDataToTables();
    }
  }

  // Función principal para cargar datos del canvas
  function loadCanvasDataToTables() {
    if (!canvasData) return;

    // Ubicación Curricular
    const ubicacionTable = document.getElementById('ubicacionTable');
    while (ubicacionTable.rows.length > 1) ubicacionTable.deleteRow(1);

    const row = ubicacionTable.insertRow();
    
    // Problema
    const problemaCell = row.insertCell();
    problemaCell.textContent = canvasData.entrada || '';
    problemaCell.classList.add('editable');
    problemaCell.setAttribute('contenteditable', 'true');
    
    // PDAs
    const pdaCell = row.insertCell();
    // Inicializar lista global si no existe
    if (!window.pdaListGlobal) window.pdaListGlobal = [];
    if (Array.isArray(canvasData.pdas)) {
      canvasData.pdas.forEach(pda => {
        const pdaDiv = document.createElement('div');
        pdaDiv.classList.add('table-item', 'editable');
        pdaDiv.setAttribute('contenteditable', 'true');
        pdaDiv.textContent = pda;
        pdaCell.appendChild(pdaDiv);
        if (pda && !window.pdaListGlobal.includes(pda.trim())) window.pdaListGlobal.push(pda.trim());
      });
    } else if (canvasData.pdas) {
      pdaCell.textContent = canvasData.pdas;
      canvasData.pdas.split(/[#;\n]/).forEach(pda => {
        const trimmed = pda.trim();
        if (trimmed && !window.pdaListGlobal.includes(trimmed)) window.pdaListGlobal.push(trimmed);
      });
    }
    pdaCell.classList.add('editable');

    
    // Contenidos
    const contenidoCell = row.insertCell();
    if (Array.isArray(canvasData.contenidos)) {
      canvasData.contenidos.forEach(contenido => {
        const contenidoDiv = document.createElement('div');
        contenidoDiv.classList.add('table-item', 'editable');
        contenidoDiv.setAttribute('contenteditable', 'true');
        contenidoDiv.textContent = contenido;
        contenidoCell.appendChild(contenidoDiv);
      });
    } else if (canvasData.contenidos) {
      contenidoCell.textContent = canvasData.contenidos;
    }
    contenidoCell.classList.add('editable');
    
    // Campos Formativos
    const campoCell = row.insertCell();
    if (Array.isArray(canvasData.campos)) {
      canvasData.campos.forEach(campo => {
        const campoDiv = document.createElement('div');
        campoDiv.classList.add('table-item', 'editable');
        campoDiv.setAttribute('contenteditable', 'true');
        campoDiv.textContent = campo;
        campoCell.appendChild(campoDiv);
      });
    } else if (canvasData.campos) {
      campoCell.textContent = canvasData.campos;
    }
    campoCell.classList.add('editable');

    

  }



 

  // Funciones para manejo de tablas
  function populateTable(tableId, data) {
    const table = document.getElementById(tableId);
    if (!table || !Array.isArray(data)) return;
    
    while (table.rows.length > 1) table.deleteRow(1);
    
    data.forEach(row => {
      if (typeof row !== 'object') return;
      const tr = table.insertRow();
      Object.values(row).forEach(value => {
        const td = tr.insertCell();
        td.className = 'editable';
        td.setAttribute('contenteditable', 'true');
        td.textContent = value || '';
      });
    });
  }

  function loadTablesData(data) {
    if (!data) return;

    if (data.ubicacionCurricular) populateTable('ubicacionTable', data.ubicacionCurricular);
    if (data.evaluacion) populateTable('evaluacionTable', data.evaluacion);
    if (data.secuenciaDidactica) populateTable('secuenciaTable', data.secuenciaDidactica);
    if (data.organizacion) populateTable('organizacionTable', data.organizacion);
    if (data.actividades) populateTable('actividadesTable', data.actividades);
    if (data.reflexiones) document.getElementById('reflexiones').innerHTML = data.reflexiones;
  }

  // Funciones para alumnos
  function renderAlumnosTable() {
    const tableBody = document.getElementById('alumnosTableBody');
    tableBody.innerHTML = '';

    alumnosData.forEach((alumno, index) => {
      const row = document.createElement('tr');
      
      const nameCell = document.createElement('td');
      nameCell.textContent = alumno.nombre;
      nameCell.style.cursor = 'pointer';
      nameCell.title = 'Doble clic para editar';
      nameCell.ondblclick = function() {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = alumno.nombre;
        input.style.width = '95%';
        input.style.fontSize = 'inherit';
        input.style.padding = '2px 4px';
        input.onblur = function() {
          alumnosData[index].nombre = input.value.trim() || alumno.nombre;
          renderAlumnosTable();
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') {
            input.blur();
          } else if (e.key === 'Escape') {
            renderAlumnosTable();
          }
        };
        nameCell.textContent = '';
        nameCell.appendChild(input);
        input.focus();
        input.select();
      };
      row.appendChild(nameCell);
      
      const niveles = ['recordar', 'comprender', 'analizar', 'aplicar', 'valorar', 'crear'];
      niveles.forEach(nivel => {
        const cell = document.createElement('td');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `nivel-${index}`;
        radio.value = nivel;
        radio.checked = alumno.nivel === nivel;
        radio.addEventListener('change', function() {
          if (this.checked) {
            row.querySelectorAll('td:not(:first-child)').forEach(c => c.classList.remove('radio-selected'));
            this.parentElement.classList.add('radio-selected');
            alumnosData[index].nivel = nivel;
          }
        });
        
        if (alumno.nivel === nivel) cell.classList.add('radio-selected');
        cell.appendChild(radio);
        row.appendChild(cell);
      });
      
      const deleteCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Eliminar';
      deleteBtn.style.padding = '5px 10px';
      deleteBtn.style.backgroundColor = '#dc3545';
      deleteBtn.style.color = 'white';
      deleteBtn.style.border = 'none';
      deleteBtn.style.borderRadius = '4px';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.addEventListener('click', () => {
        alumnosData.splice(index, 1);
        renderAlumnosTable();
      });
      deleteCell.appendChild(deleteBtn);
      row.appendChild(deleteCell);
      
      tableBody.appendChild(row);
    });
  }

  function addNewAlumno() {
    alumnosData.push({ nombre: `Alumno ${alumnosData.length + 1}`, nivel: '' });
    renderAlumnosTable();
  } // Solo debe ejecutarse una vez por click, listeners únicos.

  function saveAlumnosData() {
    localStorage.setItem('alumnosData', JSON.stringify(alumnosData));
    closeAlumnosModal();
    updateChart();
  }

  function updateChart() {
    const chartContainer = document.getElementById('chartContainer');
    const ctx = document.getElementById('logroChart').getContext('2d');
    
    if (alumnosData.length === 0) {
      chartContainer.style.display = 'none';
      return;
    }
    
    chartContainer.style.display = 'block';
    
    const niveles = ['recordar', 'comprender', 'analizar', 'aplicar', 'valorar', 'crear'];
    const counts = niveles.map(nivel => alumnosData.filter(alumno => alumno.nivel === nivel).length);
    
    if (logroChart) logroChart.destroy();
    
    logroChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Recordar', 'Comprender', 'Analizar', 'Aplicar', 'Valorar', 'Crear'],
        datasets: [{
          label: 'Número de alumnos',
          data: counts,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Número de alumnos' },
            ticks: { stepSize: 1, precision: 0 }
          },
          x: {
            title: { display: true, text: 'Niveles de logro' }
          }
        }
      }
    });
  }

  // Funciones para importar/exportar
  function downloadExcelTemplate() {
    const wb = XLSX.utils.book_new();
    const wsData = [
      ["Nombre del Alumno"],
      ["Ejemplo: Juan Pérez"],
      [""],
      [""],
      [""]
    ];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Alumnos");
    XLSX.writeFile(wb, "Formato_Alumnos.xlsx");
  }

  function handleExcelImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        const newAlumnos = [];
        jsonData.forEach((row, index) => {
          if (index > 0 && row[0] && typeof row[0] === 'string' && row[0].trim() !== '') {
            newAlumnos.push({ nombre: row[0].trim(), nivel: '' });
          }
        });
        
        if (newAlumnos.length > 0) {
          // Evita duplicados: solo agrega si no existe ya ese nombre
          newAlumnos.forEach(nuevo => {
            if (!alumnosData.some(a => a.nombre === nuevo.nombre)) {
              alumnosData.push(nuevo);
            }
          });
          renderAlumnosTable();
          alert(`${newAlumnos.length} alumnos importados correctamente.`);
        } else {
          alert('No se encontraron nombres de alumnos en el archivo.');
        }
      } catch (error) {
        console.error('Error al procesar el archivo Excel:', error);
        alert('Error al procesar el archivo Excel.');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // Funciones para modales
  function openAlumnosModal() {
    document.getElementById('alumnosModal').style.display = 'block';
    renderAlumnosTable();
  }

  function closeAlumnosModal() {
    document.getElementById('alumnosModal').style.display = 'none';
  }

  function openLoadModal() {
    document.getElementById('loadModal').style.display = 'block';
  }

  function closeLoadModal() {
    document.getElementById('loadModal').style.display = 'none';
  }

  function loadFromLocalStorage() {
    const savedData = localStorage.getItem('tablesData');
    if (savedData) {
      loadTablesData(JSON.parse(savedData));
      alert('Datos cargados desde almacenamiento local');
    } else {
      alert('No hay datos guardados localmente');
    }
    closeLoadModal();
  }

  function loadFromCanvasData() {
    if (!canvasData) {
      alert('No hay datos del canvas disponibles');
      closeLoadModal();
      return;
    }
    loadCanvasDataToTables();
    alert('Datos del canvas cargados correctamente');
    closeLoadModal();
  }

  // Funciones generales
  function makeAllCellsEditable() {
    document.querySelectorAll('td').forEach(td => {
      if (!td.hasAttribute('contenteditable')) {
        td.setAttribute('contenteditable', 'true');
        td.classList.add('editable');
      }
    });
  }

  function togglePrintMode() {
    document.body.classList.toggle('print-mode');
    const btn = document.querySelector('.toolbar button:nth-child(3)');
    btn.textContent = document.body.classList.contains('print-mode') ? 'Modo Edición' : 'Modo Impresión';
  }

  function savePlan() {
    const planContent = {
      datosGenerales: {},
      ubicacionCurricular: [],
      evaluacion: [],
      secuenciaDidactica: [],
      organizacion: [],
      actividades: [],
      reflexiones: document.getElementById('reflexiones').innerHTML,
      alumnosData: alumnosData
    };

    document.querySelectorAll('table').forEach(table => {
      if (table.id === 'evaluacionTable' || table.id === 'alumnosTable') return;
      
      const rows = Array.from(table.rows).slice(1);
      rows.forEach(row => {
        const rowData = {};
        Array.from(row.cells).forEach((cell, i) => {
          if (!cell.querySelector('button')) {
            const header = table.rows[0].cells[i].textContent;
            rowData[header] = cell.textContent;
          }
        });
        
        if (table.id === 'ubicacionTable') planContent.ubicacionCurricular.push(rowData);
        else if (table.id === 'evaluacionTable') planContent.evaluacion.push(rowData);
        else if (table.id === 'secuenciaTable') planContent.secuenciaDidactica.push(rowData);
        else if (table.id === 'organizacionTable') planContent.organizacion.push(rowData);
        else if (table.id === 'actividadesTable') planContent.actividades.push(rowData);
      });
    });

    localStorage.setItem('tablesData', JSON.stringify(planContent));

    const blob = new Blob([JSON.stringify(planContent, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'plan-didactico-' + new Date().toISOString().slice(0,10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('Plan guardado correctamente');
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    loadUserData();
    makeAllCellsEditable();

    // --- NUEVO: Cargar planViewerData si existe ---
    let planViewerData = null;
    let canvasDataDebug = null;
    try {
      planViewerData = JSON.parse(localStorage.getItem('planViewerData'));
    } catch (e) { planViewerData = null; }
    try {
      canvasDataDebug = JSON.parse(localStorage.getItem('canvasData'));
    } catch (e) { canvasDataDebug = null; }
    // Prefer planViewerData, fallback to canvasData
    let proyectoValue = (planViewerData && planViewerData.proyecto) ? planViewerData.proyecto : (canvasDataDebug && canvasDataDebug.proyecto ? canvasDataDebug.proyecto : '');
    let metodologiaValue = (planViewerData && planViewerData.metodologia) ? planViewerData.metodologia : (canvasDataDebug && canvasDataDebug.metodologia ? canvasDataDebug.metodologia : '');
    document.getElementById('nombreProyecto').textContent = proyectoValue;
    document.getElementById('metodologia').textContent = metodologiaValue;
    if (planViewerData && planViewerData.metodologia) {
      construirTablaSecuencia(planViewerData.metodologia);
    }
    if (document.getElementById('planViewerDataRaw'))
      document.getElementById('planViewerDataRaw').value = JSON.stringify(planViewerData, null, 2);
    // Debug
    console.log('[DEBUG] planViewerData:', planViewerData);
    console.log('[DEBUG] canvasData:', canvasDataDebug);
    console.log('[DEBUG] Proyecto mostrado:', proyectoValue);
    console.log('[DEBUG] Metodología mostrada:', metodologiaValue);
    if (document.getElementById('add-alumnos-btn')) document.getElementById('add-alumnos-btn').addEventListener('click', openAlumnosModal);
    // Elimina listeners previos si existen para evitar duplicados
    if (document.getElementById('addAlumnoBtn')) {
      document.getElementById('addAlumnoBtn').onclick = null;
      document.getElementById('addAlumnoBtn').addEventListener('click', addNewAlumno);
    }
    if (document.getElementById('saveAlumnosBtn')) {
      document.getElementById('saveAlumnosBtn').onclick = null;
      document.getElementById('saveAlumnosBtn').addEventListener('click', saveAlumnosData);
    }
    if (document.getElementById('excelInput')) {
      document.getElementById('excelInput').onchange = null;
      document.getElementById('excelInput').addEventListener('change', handleExcelImport);
    }
    if (document.getElementById('downloadTemplateBtn')) document.getElementById('downloadTemplateBtn').addEventListener('click', downloadExcelTemplate);
    if (document.querySelector('#alumnosModal .close')) document.querySelector('#alumnosModal .close').addEventListener('click', closeAlumnosModal);
    if (document.querySelector('#loadModal .close')) document.querySelector('#loadModal .close').addEventListener('click', closeLoadModal);

    window.addEventListener('click', function(event) {
      if (event.target === document.getElementById('alumnosModal')) closeAlumnosModal();
      if (event.target === document.getElementById('loadModal')) closeLoadModal();
    });
});

// Listener para mensajes del canvas
  window.addEventListener('message', (event) => {
    if (event.data.type === 'loadData') {
      try {
        if (!event.data.tables || !event.data.config) {
          throw new Error('Formato de datos incorrecto');
        }

        canvasData = {
          proyecto: event.data.config.proyecto || '',
          metodologia: event.data.config.metodologia || '',
          entrada: event.data.tables.ubicacion?.[0]?.Problema || '',
          pdas: event.data.tables.ubicacion?.[0]?.['PDA(s)']?.split(', ') || [],
          campos: event.data.tables.ubicacion?.[0]?.['Campo(s) Formativo(s)']?.split(', ') || [],
          contenidos: event.data.tables.ubicacion?.[0]?.['Contenido(s)']?.split(', ') || [],
          fases: event.data.tables.organizacion?.map(row => row.Fase) || []
        };
        
        localStorage.setItem('canvasData', JSON.stringify(canvasData));
        loadCanvasDataToTables();

        let planViewerData = {};
        let canvasDataDebug = null;
        try {
          planViewerData = JSON.parse(localStorage.getItem('planViewerData')) || {};
        } catch (e) { planViewerData = {}; }
        try {
          canvasDataDebug = JSON.parse(localStorage.getItem('canvasData'));
        } catch (e) { canvasDataDebug = null; }
        // Prefer planViewerData, fallback to canvasData
        let proyectoValue = (planViewerData && planViewerData.proyecto) ? planViewerData.proyecto : (canvasDataDebug && canvasDataDebug.proyecto ? canvasDataDebug.proyecto : '');
        let metodologiaValue = (planViewerData && planViewerData.metodologia) ? planViewerData.metodologia : (canvasDataDebug && canvasDataDebug.metodologia ? canvasDataDebug.metodologia : '');
        document.getElementById('nombreProyecto').textContent = proyectoValue;
        document.getElementById('metodologia').textContent = metodologiaValue;
        // Debug
        console.log('[DEBUG][msg event] planViewerData:', planViewerData);
        console.log('[DEBUG][msg event] canvasData:', canvasDataDebug);
        console.log('[DEBUG][msg event] Proyecto mostrado:', proyectoValue);
        console.log('[DEBUG][msg event] Metodología mostrada:', metodologiaValue);
        
        if (event.data.tables.secuencia) populateTable('secuenciaTable', event.data.tables.secuencia);
        if (event.data.tables.organizacion) populateTable('organizacionTable', event.data.tables.organizacion);
        if (event.data.tables.actividades) populateTable('actividadesTable', event.data.tables.actividades);
        if (event.data.reflexiones) document.getElementById('reflexiones').innerHTML = event.data.reflexiones;
        
        // Excluir las celdas de nombreProyecto y metodologia de ser editables
        makeAllCellsEditable(['nombreProyecto', 'metodologia']);
        
      } catch (error) {
        console.error('Error al cargar datos:', error);
        alert('Error al cargar los datos generados por IA');
      }
    }
  });

// --- UBICACIÓN CURRICULAR: RECOLECCIÓN Y TABLA DESDE EL CANVAS ---
function buildUbicacionTableFromCanvas() {
  const tableBody = document.querySelector('#ubicacionTable tbody');
  tableBody.innerHTML = '';
  
  // Obtener datos del canvas
  let planViewerData = null;
  try {
    planViewerData = JSON.parse(localStorage.getItem('planViewerData'));
  } catch (e) {
    console.error('Error parsing planViewerData:', e);
    return;
  }
  
  if (!planViewerData || !planViewerData.ubicacion) return;

  // Crear un mapa para organizar los datos jerárquicamente
  const hierarchyMap = new Map();

  planViewerData.ubicacion.forEach(row => {
    const problema = row['Problema'] || '';
    const campo = row['Campo(s) Formativo(s)'] || '';
    const contenido = row['Contenido(s)'] || '';
    const pda = row['PDA(s)'] || '';

    if (!hierarchyMap.has(problema)) {
      hierarchyMap.set(problema, new Map());
    }
    
    const camposMap = hierarchyMap.get(problema);
    if (!camposMap.has(campo)) {
      camposMap.set(campo, new Map());
    }
    
    const contenidosMap = camposMap.get(campo);
    if (!contenidosMap.has(contenido)) {
      contenidosMap.set(contenido, new Set());
    }
    
    const pdaSet = contenidosMap.get(contenido);
    if (pda) {
      pda.split('#').forEach(p => pdaSet.add(p.trim()));
    }
  });

  // Construir la tabla respetando la jerarquía
  hierarchyMap.forEach((camposMap, problema) => {
    let firstProblemaRow = true;
    let problemaRowspan = 0;
    
    // Calcular rowspan para problema
    camposMap.forEach(contenidosMap => {
      contenidosMap.forEach(pdaSet => {
        problemaRowspan += Math.max(1, pdaSet.size);
      });
    });

    // Usar el valor seleccionado en Entrada si existe
    let problemaMostrar = (planViewerData && planViewerData.problemaSeleccionado && planViewerData.problemaSeleccionado !== '-') ? planViewerData.problemaSeleccionado : problema;

    camposMap.forEach((contenidosMap, campo) => {
      let firstCampoRow = true;
      let campoRowspan = 0;
      
      // Calcular rowspan para campo
      contenidosMap.forEach(pdaSet => {
        campoRowspan += Math.max(1, pdaSet.size);
      });

      contenidosMap.forEach((pdaSet, contenido) => {
        const pdas = Array.from(pdaSet);
        const contenidoRowspan = Math.max(1, pdaSet.size);

        for (let i = 0; i < Math.max(1, pdas.length); i++) {
          const row = document.createElement('tr');
          // Celda de Problema (solo en la primera fila para este problema)
          if (firstProblemaRow) {
            const tdProblema = document.createElement('td');
            tdProblema.textContent = problemaMostrar;
            tdProblema.rowSpan = problemaRowspan;
            tdProblema.style.verticalAlign = 'top';
            row.appendChild(tdProblema);
            firstProblemaRow = false;
          }
          // Celda de Campo (solo en la primera fila para este campo)
          if (i === 0) {
            const tdCampo = document.createElement('td');
            tdCampo.textContent = campo;
            tdCampo.rowSpan = campoRowspan;
            tdCampo.style.verticalAlign = 'top';
            row.appendChild(tdCampo);
            firstCampoRow = false;
          }
          // Celda de Contenido (solo en la primera fila para este contenido)
          if (i === 0) {
            const tdContenido = document.createElement('td');
            tdContenido.textContent = contenido;
            tdContenido.rowSpan = contenidoRowspan;
            tdContenido.style.verticalAlign = 'top';
            row.appendChild(tdContenido);
          }
          // Celda de PDA
          const tdPDA = document.createElement('td');
          tdPDA.textContent = pdas[i] || '';
          row.appendChild(tdPDA);
          
          tableBody.appendChild(row);
        }
      });
    });
  });
}
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar JSON crudo de planViewerData
  const rawArea = document.getElementById('planViewerDataRaw');
  const raw = localStorage.getItem('planViewerData');
  rawArea.value = raw ? raw : 'No hay datos en localStorage.planViewerData';
  buildUbicacionTableFromCanvas();
});

// --- UBICACIÓN CURRICULAR: ASOCIAR PDAs SOLO A SU CONTENIDO CORRECTO ---
function buildUbicacionTableFromCanvas() {
  const tableBody = document.querySelector('#ubicacionTable tbody');
  tableBody.innerHTML = '';
  
  // Obtener datos del canvas
  let planViewerData = null;
  try {
    planViewerData = JSON.parse(localStorage.getItem('planViewerData'));
  } catch (e) {
    console.error('Error parsing planViewerData:', e);
    return;
  }
  
  // DEBUG: Inspeccionar estructura completa antes de procesar
  console.log('planViewerData:', planViewerData);
  if (planViewerData && Array.isArray(planViewerData.ubicacion)) {
    planViewerData.ubicacion.forEach((problemaObj, idx) => {
      console.log(`Problema #${idx}:`, problemaObj);
      if (problemaObj.campos && Array.isArray(problemaObj.campos)) {
        problemaObj.campos.forEach((campoObj, cidx) => {
          console.log(`  Campo #${cidx}:`, campoObj);
          if (campoObj.contenidos && Array.isArray(campoObj.contenidos)) {
            campoObj.contenidos.forEach((contenidoObj, coidx) => {
              console.log(`    Contenido #${coidx}:`, contenidoObj);
              if (Array.isArray(contenidoObj.pdas)) {
                console.log(`      PDAs:`, contenidoObj.pdas);
              }
            });
          }
        });
      }
    });
  }
  if (!planViewerData || !planViewerData.ubicacion || !Array.isArray(planViewerData.ubicacion) || planViewerData.ubicacion.length === 0) {
    // Mostrar fila vacía si no hay datos
    const row = document.createElement('tr');
    for (let i = 0; i < 4; i++) {
      const td = document.createElement('td');
      td.textContent = '-';
      row.appendChild(td);
    }
    tableBody.appendChild(row);
    return;
  }

  // Helper para calcular rowspans
  function calcRowspanCampo(contenidos) {
    if (!Array.isArray(contenidos) || contenidos.length === 0) return 1;
    return contenidos.reduce((sum, c) => sum + (Array.isArray(c.pdas) ? (c.pdas.length || 1) : 1), 0);
  }
  function calcRowspanProblema(campos) {
    if (!Array.isArray(campos) || campos.length === 0) return 1;
    return campos.reduce((sum, campo) => sum + calcRowspanCampo(campo.contenidos), 0);
  }

  // Renderizar la tabla jerárquica: problema → campo → contenidos → pdas
  let idx = 0;
  let lastProblema = null;
  planViewerData.ubicacion.forEach((campoObj, i) => {
    const problema = campoObj.problema || '-';
    const campo = campoObj.campo || '-';
    const contenidos = Array.isArray(campoObj.contenidos) ? campoObj.contenidos : [];
    const campoRowspan = contenidos.reduce((sum, cont) => sum + (cont.pdas && cont.pdas.length ? cont.pdas.length : 1), 0) || 1;
    // Calcular rowSpan para problema
    let nextIdx = i;
    let problemaRowspan = 0;
    while (nextIdx < planViewerData.ubicacion.length && (planViewerData.ubicacion[nextIdx].problema === problema)) {
      const c = planViewerData.ubicacion[nextIdx];
      const cs = Array.isArray(c.contenidos) ? c.contenidos : [];
      problemaRowspan += cs.reduce((sum, cont) => sum + (cont.pdas && cont.pdas.length ? cont.pdas.length : 1), 0) || 1;
      nextIdx++;
    }
    let firstCampoRow = true;
    contenidos.forEach((contenidoObj) => {
      const contenido = contenidoObj.contenido || '-';
      const pdas = Array.isArray(contenidoObj.pdas) && contenidoObj.pdas.length ? contenidoObj.pdas : ['-'];
      let firstContenidoRow = true;
      pdas.forEach((pda) => {
        const row = document.createElement('tr');
        // Problema solo en la primera fila del bloque
        if (lastProblema !== problema) {
          const tdProblema = document.createElement('td');
          // Mostrar el valor seleccionado del nodo Entrada si existe
          let problemaMostrar = (planViewerData && planViewerData.problemaSeleccionado && planViewerData.problemaSeleccionado !== '-') ? planViewerData.problemaSeleccionado : problema;
          tdProblema.textContent = problemaMostrar;
          tdProblema.rowSpan = problemaRowspan;
          tdProblema.style.verticalAlign = 'top';
          row.appendChild(tdProblema);
          lastProblema = problema;
        }
        // Campo formativo solo en la primera fila del grupo
        if (firstCampoRow) {
          const tdCampo = document.createElement('td');
          tdCampo.textContent = campo;
          tdCampo.rowSpan = campoRowspan;
          tdCampo.style.verticalAlign = 'top';
          row.appendChild(tdCampo);
          firstCampoRow = false;
        }
        // Contenido solo en la primera fila de su grupo
        if (firstContenidoRow) {
          const tdContenido = document.createElement('td');
          tdContenido.textContent = contenido;
          tdContenido.rowSpan = pdas.length;
          tdContenido.style.verticalAlign = 'top';
          row.appendChild(tdContenido);
          firstContenidoRow = false;
        }
        // PDA
        const tdPDA = document.createElement('td');
        tdPDA.textContent = pda || '-';
        row.appendChild(tdPDA);
        tableBody.appendChild(row);
        idx++;
      });
    });
    // Si no hay contenidos, mostrar el campo solo
    if (contenidos.length === 0) {
      const row = document.createElement('tr');
      if (lastProblema !== problema) {
        const tdProblema = document.createElement('td');
        tdProblema.textContent = problema;
        tdProblema.rowSpan = campoRowspan;
        tdProblema.style.verticalAlign = 'top';
        row.appendChild(tdProblema);
        lastProblema = problema;
      }
      const tdCampo = document.createElement('td');
      tdCampo.textContent = campo;
      row.appendChild(tdCampo);
      const tdContenido = document.createElement('td');
      tdContenido.textContent = '-';
      row.appendChild(tdContenido);
      const tdPDA = document.createElement('td');
      tdPDA.textContent = '-';
      row.appendChild(tdPDA);
      tableBody.appendChild(row);
      idx++;
    }
  });
}



</script>
<script>
// ==================== BLOOM & PDA EVALUACION ====================
const bloomLevels = [
  {
    name: 'Recordar',
    verbs: [
      'identificar', 'recordar', 'listar', 'nombrar', 'definir', 'repetir', 'describir', 'señalar', 'enumerar',
      'memorizar', 'buscar', 'observar', 'detallar', 'apuntar', 'mostrar', 'seleccionar', 'indicar', 'apreciar',
      'leer', 'subrayar', 'marcar', 'datar', 'copiar', 'consultar', 'visualizar', 'detectar', 'reconocer',
      'localizar', 'rememorar', 'indicar', 'asociar', 'recordar', 'citar', 'expresar', 'recitar', 'reproducir',
      'señalar', 'nombrar', 'reiterar', 'evocar', 'identificar', 'subrayar', 'repetir', 'mostrar', 'transcribir',
      'enumerar', 'distinguir', 'subrayar', 'escribir', 'marcar', 'leer', 'apuntar', 'copiar', 'consultar', 'visualizar'
    ]
  },
  {
    name: 'Comprender',
    verbs: [
      'explicar', 'interpretar', 'resumir', 'parafrasear', 'clasificar', 'comparar', 'distinguir', 'ilustrar', 'predecir', 'discutir',
      'expresar', 'traducir', 'argumentar', 'ejemplificar', 'inferir', 'concluir', 'reformular', 'relatar', 'expresarse',
      'reconstruir', 'reproducir', 'mostrar', 'ordenar', 'organizar', 'clarificar', 'asociar', 'esquematizar', 'aprender',
      'describir', 'expresar', 'resumir', 'ordenar', 'explicar', 'interpretar', 'comparar', 'clasificar', 'parafrasear',
      'discutir', 'distinguir', 'ilustrar', 'predecir', 'expresar', 'concluir', 'reformular', 'relatar', 'expresarse',
      'reorganizar', 'resumir', 'recontar', 'reformular', 'sintetizar', 'reelaborar', 'identificar', 'reconocer', 'repetir'
    ]
  },
  {
    name: 'Analizar',
    verbs: [
      'analizar', 'diferenciar', 'organizar', 'atribuir', 'descomponer', 'relacionar', 'examinar', 'contrastar', 'investigar',
      'separar', 'comparar', 'categorizar', 'detectar', 'diagnosticar', 'argumentar', 'discernir', 'clasificar',
      'esquematizar', 'desglosar', 'fragmentar', 'inspeccionar', 'desmenuzar', 'jerarquizar', 'revisar', 'explorar',
      'descomponer', 'distinguir', 'comparar', 'relacionar', 'diferenciar', 'atribuir', 'examinar', 'clasificar',
      'contrastar', 'identificar', 'investigar', 'separar', 'detectar', 'diagnosticar', 'discernir', 'esquematizar',
      'desglosar', 'fragmentar', 'inspeccionar', 'desmenuzar', 'jerarquizar', 'revisar', 'evaluar', 'analizar', 'interpretar'
    ]
  },
  {
    name: 'Aplicar',
    verbs: [
      'aplicar', 'usar', 'ejecutar', 'resolver', 'demostrar', 'implementar', 'practicar', 'operar', 'emplear', 'realizar',
      'poner', 'utilizar', 'manejar', 'desarrollar', 'construir', 'producir', 'ensayar', 'simular', 'experimentar', 'adaptar',
      'modificar', 'transferir', 'ilustrar', 'presentar', 'actuar', 'representar', 'ensamblar',
      'ejercitar', 'emplear', 'manejar', 'realizar', 'probar', 'resolver', 'dramatizar', 'utilizar', 'ensamblar',
      'demostrar', 'practicar', 'simular', 'experimentar', 'adaptar', 'modificar', 'transferir', 'presentar', 'actuar',
      'operar', 'producir', 'construir', 'elaborar', 'ejecutar', 'ensayar', 'interpretar', 'aplicar', 'usar', 'emplear','participar'
    ]
  },
  {
    name: 'Valorar',
    verbs: [
      'valorar', 'juzgar', 'defender', 'criticar', 'justificar', 'evaluar', 'argumentar', 'apreciar', 'opinar', 'discriminar',
      'seleccionar', 'estimar', 'ponderar', 'priorizar', 'reflexionar', 'concluir', 'analizar', 'comparar', 'recomendar',
      'revisar', 'apoyar', 'cuestionar', 'contrastar', 'verificar', 'validar', 'aprobar', 'rechazar', 'sopesar', 'compartir',
      'valorar', 'apreciar', 'evaluar', 'juzgar', 'criticar', 'argumentar', 'priorizar', 'ponderar', 'recomendar',
      'decidir', 'aprobar', 'reflexionar', 'discriminar', 'seleccionar', 'verificar', 'validar', 'opinar', 'concluir',
      'comparar', 'revisar', 'apoyar', 'cuestionar', 'contrastar', 'rechazar', 'sopesar', 'defender', 'justificar'
    ]
  },
  {
    name: 'Crear',
    verbs: [
      'crear', 'diseñar', 'construir', 'planificar', 'inventar', 'proponer', 'desarrollar', 'generar', 'formular', 'elaborar',
      'idear', 'componer', 'escribir', 'organizar', 'reestructurar', 'integrar', 'modificar', 'mezclar', 'combinar',
      'crear', 'componer', 'inventar', 'formular', 'elaborar', 'planificar', 'producir', 'diseñar', 'generar',
      'reorganizar', 'reestructurar', 'integrar', 'modificar', 'mezclar', 'combinar', 'escribir', 'desarrollar', 'construir'
    ]
  }
];

// Lematizador simple para español enfocado en verbos taxonómicos
const verbLemmas = {
  // Recordar
  'identifica': 'identificar', 'identifican': 'identificar', 'identificó': 'identificar', 'identificaron': 'identificar',
  'recuerda': 'recordar', 'recuerdan': 'recordar', 'recordó': 'recordar', 'recordaron': 'recordar',
  'lista': 'listar', 'listan': 'listar', 'listó': 'listar', 'listaron': 'listar',
  'nombra': 'nombrar', 'nombran': 'nombrar', 'nombró': 'nombrar', 'nombraron': 'nombrar',
  'reconoce': 'reconocer', 'reconocen': 'reconocer', 'reconoció': 'reconocer', 'reconocieron': 'reconocer',
  'describe': 'describir', 'describen': 'describir', 'describió': 'describir', 'describieron': 'describir',
  'define': 'definir', 'definen': 'definir', 'definió': 'definir', 'definieron': 'definir',
  'señala': 'señalar', 'señalan': 'señalar', 'señaló': 'señalar', 'señalaron': 'señalar',
  'localiza': 'localizar', 'localizan': 'localizar', 'localizó': 'localizar', 'localizaron': 'localizar',
  'enumera': 'enumerar', 'enumeran': 'enumerar', 'enumeró': 'enumerar', 'enumeraron': 'enumerar',
  'memoriza': 'memorizar', 'memorizan': 'memorizar', 'memorizó': 'memorizar', 'memorizaron': 'memorizar',
  'repite': 'repetir', 'repiten': 'repetir', 'repitió': 'repetir', 'repitieron': 'repetir',
  'busca': 'buscar', 'buscan': 'buscar', 'buscó': 'buscar', 'buscaron': 'buscar',
  'observa': 'observar', 'observan': 'observar', 'observó': 'observar', 'observaron': 'observar',
  'detalla': 'detallar', 'detallan': 'detallar', 'detalló': 'detallar', 'detallaron': 'detallar',
  'apunta': 'apuntar', 'apuntan': 'apuntar', 'apuntó': 'apuntar', 'apuntaron': 'apuntar',
  'muestra': 'mostrar', 'muestran': 'mostrar', 'mostró': 'mostrar', 'mostraron': 'mostrar',
  'selecciona': 'seleccionar', 'seleccionan': 'seleccionar', 'seleccionó': 'seleccionar', 'seleccionaron': 'seleccionar',
  'indica': 'indicar', 'indican': 'indicar', 'indicó': 'indicar', 'indicaron': 'indicar',
  'lee': 'leer', 'leen': 'leer', 'leyó': 'leer', 'leyeron': 'leer',
  'subraya': 'subrayar', 'subrayan': 'subrayar', 'subrayó': 'subrayar', 'subrayaron': 'subrayar',
  'marca': 'marcar', 'marcan': 'marcar', 'marcó': 'marcar', 'marcaron': 'marcar',
  'data': 'datar', 'datan': 'datar', 'dató': 'datar', 'dataron': 'datar',
  'copia': 'copiar', 'copian': 'copiar', 'copió': 'copiar', 'copiaron': 'copiar',
  'consulta': 'consultar', 'consultan': 'consultar', 'consultó': 'consultar', 'consultaron': 'consultar',
  'visualiza': 'visualizar', 'visualizan': 'visualizar', 'visualizó': 'visualizar', 'visualizaron': 'visualizar',
  'detecta': 'detectar', 'detectan': 'detectar', 'detectó': 'detectar', 'detectaron': 'detectar',
  // Comprender
  'explica': 'explicar', 'explican': 'explicar', 'explicó': 'explicar', 'explicaron': 'explicar',
  'interpreta': 'interpretar', 'interpretan': 'interpretar', 'interpretó': 'interpretar', 'interpretaron': 'interpretar',
  'resume': 'resumir', 'resumen': 'resumir', 'resumió': 'resumir', 'resumieron': 'resumir',
  'parafrasea': 'parafrasear', 'parafrasean': 'parafrasear', 'parafraseó': 'parafrasear', 'parafrasearon': 'parafrasear',
  'clasifica': 'clasificar', 'clasifican': 'clasificar', 'clasificó': 'clasificar', 'clasificaron': 'clasificar',
  'compara': 'comparar', 'comparan': 'comparar', 'comparó': 'comparar', 'compararon': 'comparar',
  'distingue': 'distinguir', 'distinguen': 'distinguir', 'distinguió': 'distinguir', 'distinguieron': 'distinguir',
  'ilustra': 'ilustrar', 'ilustran': 'ilustrar', 'ilustró': 'ilustrar', 'ilustraron': 'ilustrar',
  'predice': 'predecir', 'predicen': 'predecir', 'predijo': 'predecir', 'predijeron': 'predecir',
  'discute': 'discutir', 'discuten': 'discutir', 'discutió': 'discutir', 'discutieron': 'discutir',
  'expresa': 'expresar', 'expresan': 'expresar', 'expresó': 'expresar', 'expresaron': 'expresar',
  'traduce': 'traducir', 'traducen': 'traducir', 'tradujo': 'traducir', 'tradujeron': 'traducir',
  'argumenta': 'argumentar', 'argumentan': 'argumentar', 'argumentó': 'argumentar', 'argumentaron': 'argumentar',
  'ejemplifica': 'ejemplificar', 'ejemplifican': 'ejemplificar', 'ejemplificó': 'ejemplificar', 'ejemplificaron': 'ejemplificar',
  'infiere': 'inferir', 'infieren': 'inferir', 'infirió': 'inferir', 'infirieron': 'inferir',
  'concluye': 'concluir', 'concluyen': 'concluir', 'concluyó': 'concluir', 'concluyeron': 'concluir',
  'reformula': 'reformular', 'reformulan': 'reformular', 'reformuló': 'reformular', 'reformularon': 'reformular',
  'relata': 'relatar', 'relatan': 'relatar', 'relató': 'relatar', 'relataron': 'relatar',
  'expresarse': 'expresarse', 'expresarse': 'expresarse',
  'reconstruye': 'reconstruir', 'reconstruyen': 'reconstruir', 'reconstruyó': 'reconstruir', 'reconstruyeron': 'reconstruir',
  'reproduce': 'reproducir', 'reproducen': 'reproducir', 'reprodujo': 'reproducir', 'reprodujeron': 'reproducir',
  'muestra': 'mostrar', 'muestran': 'mostrar', 'mostró': 'mostrar', 'mostraron': 'mostrar',
  'ordena': 'ordenar', 'ordenan': 'ordenar', 'ordenó': 'ordenar', 'ordenaron': 'ordenar',
  'organiza': 'organizar', 'organizan': 'organizar', 'organizó': 'organizar', 'organizaron': 'organizar',
  'clarifica': 'clarificar', 'clarifican': 'clarificar', 'clarificó': 'clarificar', 'clarificaron': 'clarificar',
  'asocia': 'asociar', 'asocian': 'asociar', 'asoció': 'asociar', 'asociaron': 'asociar',
'aprender': 'aprender', 'aprende': 'aprender', 'aprenden': 'aprender', 'aprendió': 'aprender', 'aprendieron': 'aprender',
  'esquematiza': 'esquematizar', 'esquematizan': 'esquematizar', 'esquematizó': 'esquematizar', 'esquematizaron': 'esquematizar',
  // Analizar
  'analiza': 'analizar', 'analizan': 'analizar', 'analizó': 'analizar', 'analizaron': 'analizar',
  'explora': 'explorar', 'exploran': 'explorar', 'exploró': 'explorar', 'exploraron': 'explorar',
  'diferencia': 'diferenciar', 'diferencian': 'diferenciar', 'diferenció': 'diferenciar', 'diferenciaron': 'diferenciar',
  'organiza': 'organizar', 'organizan': 'organizar', 'organizó': 'organizar', 'organizaron': 'organizar',
  'atribuye': 'atribuir', 'atribuyen': 'atribuir', 'atribuyó': 'atribuir', 'atribuyeron': 'atribuir',
  'descompone': 'descomponer', 'descomponen': 'descomponer', 'descompuso': 'descomponer', 'descompusieron': 'descomponer',
  'relaciona': 'relacionar', 'relacionan': 'relacionar', 'relacionó': 'relacionar', 'relacionaron': 'relacionar',
  'examina': 'examinar', 'examinan': 'examinar', 'examinó': 'examinar', 'examinaron': 'examinar',
  'contrasta': 'contrastar', 'contrastan': 'contrastar', 'contrastó': 'contrastar', 'contrastaron': 'contrastar',
  'investiga': 'investigar', 'investigan': 'investigar', 'investigó': 'investigar', 'investigaron': 'investigar',
  'separa': 'separar', 'separan': 'separar', 'separó': 'separar', 'separaron': 'separar',
  'categoriza': 'categorizar', 'categorizaron': 'categorizar', 'categorizaron': 'categorizar',
  'detecta': 'detectar', 'detectan': 'detectar', 'detectó': 'detectar', 'detectaron': 'detectar',
  'diagnostica': 'diagnosticar', 'diagnostican': 'diagnosticar', 'diagnosticó': 'diagnosticar', 'diagnosticaron': 'diagnosticar',
  'discierne': 'discernir', 'disciernen': 'discernir', 'discernió': 'discernir', 'discernieron': 'discernir',
  'distingue': 'distinguir', 'distinguen': 'distinguir', 'distinguió': 'distinguir', 'distinguieron': 'distinguir',
  'clasifica': 'clasificar', 'clasifican': 'clasificar', 'clasificó': 'clasificar', 'clasificaron': 'clasificar',
  'esquematiza': 'esquematizar', 'esquematizan': 'esquematizar', 'esquematizó': 'esquematizar', 'esquematizaron': 'esquematizar',
  'desglosa': 'desglosar', 'desglosan': 'desglosar', 'desglosó': 'desglosar', 'desglosaron': 'desglosar',
  'fragmenta': 'fragmentar', 'fragmentan': 'fragmentar', 'fragmentó': 'fragmentar', 'fragmentaron': 'fragmentar',
  'inspecciona': 'inspeccionar', 'inspeccionan': 'inspeccionar', 'inspeccionó': 'inspeccionar', 'inspeccionaron': 'inspeccionar',
  'desmenuza': 'desmenuzar', 'desmenuzan': 'desmenuzar', 'desmenuzó': 'desmenuzar', 'desmenuzaron': 'desmenuzar',
  'jerarquiza': 'jerarquizar', 'jerarquizan': 'jerarquizar', 'jerarquizó': 'jerarquizar', 'jerarquizaron': 'jerarquizar',
  'revisa': 'revisar', 'revisan': 'revisar', 'revisó': 'revisar', 'revisaron': 'revisar',
  // Aplicar
  'aplica': 'aplicar', 'aplican': 'aplicar', 'aplicó': 'aplicar', 'aplicaron': 'aplicar',
  'usa': 'usar', 'usan': 'usar', 'usó': 'usar', 'usaron': 'usar',
  'ejecuta': 'ejecutar', 'ejecutan': 'ejecutar', 'ejecutó': 'ejecutar', 'ejecutaron': 'ejecutar',
  'resuelve': 'resolver', 'resuelven': 'resolver', 'resolvió': 'resolver', 'resolvieron': 'resolver',
  'demuestra': 'demostrar', 'demuestran': 'demostrar', 'demostró': 'demostrar', 'demostraron': 'demostrar',
  'implementa': 'implementar', 'implementan': 'implementar', 'implementó': 'implementar', 'implementaron': 'implementar',
  'practica': 'practicar', 'practican': 'practicar', 'practicó': 'practicar', 'practicaron': 'practicar',
  'opera': 'operar', 'operan': 'operar', 'operó': 'operar', 'operaron': 'operar',
  'emplea': 'emplear', 'emplean': 'emplear', 'empleó': 'emplear', 'emplearon': 'emplear',
  'realiza': 'realizar', 'realizan': 'realizar', 'realizó': 'realizar', 'realizaron': 'realizar',
  'pone': 'poner', 'ponen': 'poner', 'puso': 'poner', 'pusieron': 'poner',
  'utiliza': 'utilizar', 'utilizan': 'utilizar', 'utilizó': 'utilizar', 'utilizaron': 'utilizar',
  'maneja': 'manejar', 'manejan': 'manejar', 'manejó': 'manejar', 'manejaron': 'manejar',
  'desarrolla': 'desarrollar', 'desarrollan': 'desarrollar', 'desarrolló': 'desarrollar', 'desarrollaron': 'desarrollar',
  'construye': 'construir', 'construyen': 'construir', 'construyó': 'construir', 'construyeron': 'construir',
  'produce': 'producir', 'producen': 'producir', 'produjo': 'producir', 'produjeron': 'producir',
  'ensaya': 'ensayar', 'ensayan': 'ensayar', 'ensayó': 'ensayar', 'ensayaron': 'ensayar',
  'simula': 'simular', 'simulan': 'simular', 'simuló': 'simular', 'simularon': 'simular',
  'experimenta': 'experimentar', 'experimentan': 'experimentar', 'experimentó': 'experimentar', 'experimentaron': 'experimentar',
  'adapta': 'adaptar', 'adaptan': 'adaptar', 'adaptó': 'adaptar', 'adaptaron': 'adaptar',
  'modifica': 'modificar', 'modifican': 'modificar', 'modificó': 'modificar', 'modificaron': 'modificar',
  'transfiere': 'transferir', 'transfieren': 'transferir', 'transfirió': 'transferir', 'transfirieron': 'transferir',
  'presenta': 'presentar', 'presentan': 'presentar', 'presentó': 'presentar', 'presentaron': 'presentar',
  'actúa': 'actuar', 'actúan': 'actuar', 'actuó': 'actuar', 'actuaron': 'actuar',
  'representa': 'representar', 'representan': 'representar', 'representó': 'representar', 'representaron': 'representar',
  'ensambla': 'ensamblar', 'ensamblan': 'ensamblar', 'ensambló': 'ensamblar', 'ensamblaron': 'ensamblar',
  'participa': 'participar', 'participan': 'participar', 'participó': 'participar', 'participaron': 'participar',
  // Valorar
  'valora': 'valorar', 'valoran': 'valorar', 'valoró': 'valorar', 'valoraron': 'valorar',
  'comparte': 'compartir', 'comparten': 'compartir', 'compartió': 'compartir', 'compartieron': 'compartir',
  'juzga': 'juzgar', 'juzgan': 'juzgar', 'juzgó': 'juzgar', 'juzgaron': 'juzgar',
  'defiende': 'defender', 'defienden': 'defender', 'defendió': 'defender', 'defendieron': 'defender',
  'critica': 'criticar', 'critican': 'criticar', 'criticó': 'criticar', 'criticaron': 'criticar',
  'justifica': 'justificar', 'justifican': 'justificar', 'justificó': 'justificar', 'justificaron': 'justificar',
  'evalua': 'evaluar', 'evalúan': 'evaluar', 'evalúan': 'evaluar', 'evaluó': 'evaluar', 'evaluaron': 'evaluar',
  'argumenta': 'argumentar', 'argumentan': 'argumentar', 'argumentó': 'argumentar', 'argumentaron': 'argumentar',
  'aprecia': 'apreciar', 'aprecian': 'apreciar', 'apreció': 'apreciar', 'apreciaron': 'apreciar',
  'opina': 'opinar', 'opinan': 'opinar', 'opinó': 'opinar', 'opinaron': 'opinar',
  'discrimina': 'discriminar', 'discriminan': 'discriminar', 'discriminó': 'discriminar', 'discriminaron': 'discriminar',
  'selecciona': 'seleccionar', 'seleccionan': 'seleccionar', 'seleccionó': 'seleccionar', 'seleccionaron': 'seleccionar',
  'estima': 'estimar', 'estiman': 'estimar', 'estimó': 'estimar', 'estimaron': 'estimar',
  'pondera': 'ponderar', 'ponderan': 'ponderar', 'ponderó': 'ponderar', 'ponderaron': 'ponderar',
  'prioriza': 'priorizar', 'priorizan': 'priorizar', 'priorizó': 'priorizar', 'priorizaron': 'priorizar',
  'reflexiona': 'reflexionar', 'reflexionan': 'reflexionar', 'reflexionó': 'reflexionar', 'reflexionaron': 'reflexionar',
  'concluye': 'concluir', 'concluyen': 'concluir', 'concluyó': 'concluir', 'concluyeron': 'concluir',
  'analiza': 'analizar', 'analizan': 'analizar', 'analizó': 'analizar', 'analizaron': 'analizar',
  'compara': 'comparar', 'comparan': 'comparar', 'comparó': 'comparar', 'compararon': 'comparar',
  'recomienda': 'recomendar', 'recomiendan': 'recomendar', 'recomendó': 'recomendar', 'recomendaron': 'recomendar',
  'revisa': 'revisar', 'revisan': 'revisar', 'revisó': 'revisar', 'revisaron': 'revisar',
  'apoya': 'apoyar', 'apoyan': 'apoyar', 'apoyó': 'apoyar', 'apoyaron': 'apoyar',
  'cuestiona': 'cuestionar', 'cuestionan': 'cuestionar', 'cuestionó': 'cuestionar', 'cuestionaron': 'cuestionar',
  'contrasta': 'contrastar', 'contrastan': 'contrastar', 'contrastó': 'contrastar', 'contrastaron': 'contrastar',
  'verifica': 'verificar', 'verifican': 'verificar', 'verificó': 'verificar', 'verificaron': 'verificar',
  'valida': 'validar', 'validan': 'validar', 'validó': 'validar', 'validaron': 'validar',
  'aprueba': 'aprobar', 'aprueban': 'aprobar', 'aprobó': 'aprobar', 'aprobaron': 'aprobar',
  'rechaza': 'rechazar', 'rechazan': 'rechazar', 'rechazó': 'rechazar', 'rechazaron': 'rechazar',
  'sopesa': 'sopesar', 'sopesan': 'sopesar', 'sopesó': 'sopesar', 'sopesaron': 'sopesar',
  // Crear
  'crea': 'crear', 'crean': 'crear', 'creó': 'crear', 'crearon': 'crear',
  'diseña': 'diseñar', 'diseñan': 'diseñar', 'diseñó': 'diseñar', 'diseñaron': 'diseñar',
  'construye': 'construir', 'construyen': 'construir', 'construyó': 'construir', 'construyeron': 'construir',
  'formula': 'formular', 'formulan': 'formular', 'formuló': 'formular', 'formularon': 'formular',
  'planea': 'planear', 'planean': 'planear', 'planeó': 'planear', 'planearon': 'planear',
  'genera': 'generar', 'generan': 'generar', 'generó': 'generar', 'generaron': 'generar',
  'produce': 'producir', 'producen': 'producir', 'produjo': 'producir', 'produjeron': 'producir',
  'inventa': 'inventar', 'inventan': 'inventar', 'inventó': 'inventar', 'inventaron': 'inventar',
  'elabora': 'elaborar', 'elaboran': 'elaborar', 'elaboró': 'elaborar', 'elaboraron': 'elaborar',
  'propone': 'proponer', 'proponen': 'proponer', 'propuso': 'proponer', 'propusieron': 'proponer',
  'organiza': 'organizar', 'organizan': 'organizar', 'organizó': 'organizar', 'organizaron': 'organizar',
  'compone': 'componer', 'componen': 'componer', 'compuso': 'componer', 'compusieron': 'componer',
  'registra': 'registrar', 'registran': 'registrar',
};

function lemmatize(word) {
  return verbLemmas[word.toLowerCase()] || word.toLowerCase();
}

function getBloomLevelsAndHighlight(pda, pdaIdx) {
  let levels = [];
  let html = pda;
  // Extraer todas las palabras del PDA
  let words = (pda.match(/\w+|[áéíóúñ]+/gi) || []).map(w => w.normalize('NFD').replace(/[^\w\u0300-\u036fáéíóúüñÁÉÍÓÚÜÑ-]/gi, '').toLowerCase());
  // Para resaltar todos los verbos, primero construimos un regex global de todos los verbos y sus formas
  let allVerbs = [];
  bloomLevels.forEach(level => {
    allVerbs = allVerbs.concat(level.verbs);
  });
  allVerbs = allVerbs.concat(Object.keys(verbLemmas));
  // Soporte para acentos y mayúsculas, buscar variantes
  allVerbs = Array.from(new Set(allVerbs.map(v => v.normalize('NFD').replace(/[^\w\u0300-\u036fáéíóúüñÁÉÍÓÚÜÑ-]/gi, ''))));
  allVerbs.sort((a, b) => b.length - a.length);
  let regex = new RegExp(`\\b(${allVerbs.join('|')})\\b`, 'gi');
  // Resaltar todos los verbos encontrados (formas y lemmas)
  html = html.replace(regex, (match) => {
    // Determinar el nivel de logro para el verbo lematizado
    const lemma = lemmatize(match.normalize('NFD').replace(/[^\w\u0300-\u036fáéíóúüñÁÉÍÓÚÜÑ-]/gi, ''));
    let nivel = null;
    for (let i = 0; i < bloomLevels.length; i++) {
      if (bloomLevels[i].verbs.includes(lemma)) {
        nivel = bloomLevels[i].name;
        break;
      }
    }
    // Si no se encuentra el lemma directo, buscar por match directo
    if (!nivel) {
      for (let i = 0; i < bloomLevels.length; i++) {
        if (bloomLevels[i].verbs.includes(match.toLowerCase())) {
          nivel = bloomLevels[i].name;
          break;
        }
      }
    }
    // Todos los verbos destacados son clickeables, tengan o no nivel Bloom
    if (nivel) {
      return `<b style="color:#1b8a3a;cursor:pointer;text-decoration:underline;" class="bloom-verb-clickable" data-verb="${match}" data-nivel="${nivel}" data-pda-idx="${pdaIdx}">${match}</b>`;
    } else {
      return `<b style=\"color:#1b8a3a;cursor:pointer;text-decoration:underline;\" class=\"bloom-verb-clickable no-bloom-level\" data-verb=\"${match}\" data-nivel=\"\" data-pda-idx=\"${pdaIdx}\" title=\"Verbo no indexado en Bloom\">${match}</b>`;
    }
  });
  // Identificar los niveles presentes usando lematización
  bloomLevels.forEach(level => {
    level.verbs.forEach(verb => {
      for (let w of words) {
        if (lemmatize(w) === verb && !levels.includes(level.name)) {
          levels.push(level.name);
        }
      }
    });
  });
  return { levels, html };
}







// Ejecutar al cargar y cada vez que cambien los PDAs
// Ejecutar al cargar y cada vez que cambien los PDAs
// Si tienes un evento donde se actualiza la tabla de PDAs, llama también a crearTablaEvaluacionOrdenada();
// --- ORGANIZACIÓN TABLE DYNAMIC LOGIC ---

let fasesSecuencia = [];
let etapasSecuencia = [];
let metodologiaActual = '';
let mediosRecyclingList = [];

function getSecuenciaFasesEtapas() {
  // Try to get from secuenciaTable if present, fallback to planViewerData
  fasesSecuencia = [];
  etapasSecuencia = [];
  metodologiaActual = '';
  const secTable = document.getElementById('secuenciaTable');
  if (secTable && secTable.rows.length > 1) {
    for (let i = 1; i < secTable.rows.length; i++) {
      const row = secTable.rows[i];
      const fase = row.cells[0]?.textContent?.trim();
      if (fase && !fasesSecuencia.includes(fase)) fasesSecuencia.push(fase);
      if (row.cells.length > 1) {
        const etapa = row.cells[1]?.textContent?.trim();
        if (etapa && !etapasSecuencia.includes(etapa)) etapasSecuencia.push(etapa);
      }
    }
  } else {
    // fallback to planViewerData
    let planViewerData = null;
    try {
      planViewerData = JSON.parse(localStorage.getItem('planViewerData'));
    } catch (e) {}
    if (planViewerData && Array.isArray(planViewerData.secuenciaDidactica)) {
      planViewerData.secuenciaDidactica.forEach(row => {
        if (row.Fase && !fasesSecuencia.includes(row.Fase)) fasesSecuencia.push(row.Fase);
        if (row.Etapa && !etapasSecuencia.includes(row.Etapa)) etapasSecuencia.push(row.Etapa);
      });
      metodologiaActual = planViewerData.metodologia || '';
    }
  }
  // Also try to get metodologia from DOM
  const metoElem = document.getElementById('metodologia');
  if (metoElem && metoElem.textContent.trim()) metodologiaActual = metoElem.textContent.trim();
}

function showHideEtapaColumn() {
  const show = metodologiaActual.toLowerCase().includes('proyectos');
  document.getElementById('etapaHeader').style.display = show ? '' : 'none';
  document.querySelectorAll('.etapa-col').forEach(td => td.style.display = show ? '' : 'none');
}

function renderOrganizacionTable(rows) {
  getSecuenciaFasesEtapas();
  showHideEtapaColumn();
  const tbody = document.getElementById('organizacionTableBody');
  tbody.innerHTML = '';
  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');
    // Fase
    const faseTd = document.createElement('td');
    const faseSel = document.createElement('select');
    faseSel.className = 'fase-select';
    faseSel.innerHTML = '<option value="">Selecciona</option>' + fasesSecuencia.map(f => `<option value="${f}"${row.Fase===f?' selected':''}>${f}</option>`).join('');
    faseSel.onchange = () => saveOrganizacionRows();
    faseTd.appendChild(faseSel);
    tr.appendChild(faseTd);
    // Etapa (conditionally)
    const etapaTd = document.createElement('td');
    etapaTd.className = 'etapa-col';
    etapaTd.style.display = metodologiaActual.toLowerCase().includes('proyectos') ? '' : 'none';
    const etapaSel = document.createElement('select');
    etapaSel.innerHTML = '<option value="">Selecciona</option>' + etapasSecuencia.map(e => `<option value="${e}"${row.Etapa===e?' selected':''}>${e}</option>`).join('');
    etapaSel.onchange = () => saveOrganizacionRows();
    etapaTd.appendChild(etapaSel);
    tr.appendChild(etapaTd);
    // Tiempo (numeric)
    const tiempoTd = document.createElement('td');
    const tiempoInput = document.createElement('input');
    tiempoInput.type = 'number';
    tiempoInput.min = 0;
    tiempoInput.value = row.Tiempo || '';
    tiempoInput.style.width = '70px';
    tiempoInput.oninput = () => saveOrganizacionRows();
    tiempoTd.appendChild(tiempoInput);
    tr.appendChild(tiempoTd);
    // Espacio (dropdown)
    const espacioTd = document.createElement('td');
    const espacioSel = document.createElement('select');
    ['','Biblioteca','Aula','Exterior','Laboratorio'].forEach(opt => {
      const o = document.createElement('option');
      o.value = opt;
      o.textContent = opt || 'Selecciona';
      if (row.Espacio === opt) o.selected = true;
      espacioSel.appendChild(o);
    });
    espacioSel.onchange = () => saveOrganizacionRows();
    espacioTd.appendChild(espacioSel);
    tr.appendChild(espacioTd);
    // Medios (textarea autoajustable + recycle button)
    const mediosTd = document.createElement('td');
    const mediosInput = document.createElement('textarea');
    mediosInput.value = row.Medios || '';

    mediosInput.className = 'auto-grow';
    mediosInput.style.width = '90%';
    mediosInput.style.minHeight = '38px';
    mediosInput.style.resize = 'vertical';
    mediosInput.oninput = function() {
      autoGrowTextarea(mediosInput);
      saveOrganizacionRows();
    };
    // Ajuste inicial
    setTimeout(() => autoGrowTextarea(mediosInput), 0);
    mediosTd.appendChild(mediosInput);
    const recycleBtn = document.createElement('button');
    recycleBtn.type = 'button';
    recycleBtn.className = 'recycle-btn';
    recycleBtn.textContent = '♻️';
    // Bloqueo robusto para cuentas básicas: el click NUNCA llega al handler IA
    recycleBtn.addEventListener('click', function(e) {
      try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData || userData.membership !== 'premium') {
          alert('Solo usuarios premium pueden usar la IA.');
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      } catch(err) {
        alert('Solo usuarios premium pueden usar la IA.');
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
      // Si es premium, el handler IA se ejecutará normalmente
    }, true);
    // Handler IA (solo si es premium y con crédito)
    recycleBtn.addEventListener('click', async function(e) {
      try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData || userData.membership !== 'premium') return; // Ya bloqueado arriba
        if (typeof descontarCreditoUsuario === 'function') {
          const creditosRestantes = await descontarCreditoUsuario();
          if (creditosRestantes <= 0) {
            alert('No tienes créditos suficientes para usar la IA.');
            e.preventDefault();
            return;
          }
        }
      } catch(err) { return; }
      // Aquí sigue el flujo IA normal
    });
    // Enable/disable ♻️ button based on required fields
    function checkRecycleEnabled() {
      const faseVal = faseSel.value;
      const etapaVal = metodologiaActual.toLowerCase().includes('proyectos') ? etapaSel.value : 'ok';
      const tiempoVal = tiempoInput.value;
      const espacioVal = espacioSel.value;
      // All must be filled
      recycleBtn.disabled = !(faseVal && etapaVal && tiempoVal && espacioVal);
    }
    // Initial check
    checkRecycleEnabled();
    // Attach change listeners
    faseSel.addEventListener('change', checkRecycleEnabled);
    etapaSel.addEventListener('change', checkRecycleEnabled);
    tiempoInput.addEventListener('input', checkRecycleEnabled);
    espacioSel.addEventListener('change', checkRecycleEnabled);

    // Left-click: collect data, fetch moments, strategy, call AI, show result
    recycleBtn.onclick = async (e) => {
      if (recycleBtn.disabled) return;
      recycleBtn.disabled = true;
      recycleBtn.textContent = '⏳';
      // Collect data
      const fase = faseSel.value;
      const etapa = metodologiaActual.toLowerCase().includes('proyectos') ? etapaSel.value : '';
      const tiempo = tiempoInput.value;
      const espacio = espacioSel.value;
      // Buscar la estrategia y momento asociado
      let estrategia = '';
      let momentoText = '';
      try {
        const secTable = document.getElementById('secuenciaTable');
        if (secTable) {
          for (let i = 1; i < secTable.rows.length; i++) {
            const row = secTable.rows[i];
            const faseCell = row.cells[0]?.textContent?.trim();
            const etapaCell = row.cells.length > 4 ? row.cells[1]?.textContent?.trim() : '';
            if (faseCell === fase && (!etapa || etapaCell === etapa)) {
              estrategia = row.cells[2]?.textContent?.trim() || '';
              const momentoCell = row.cells[row.cells.length-1];
              momentoText = momentoCell?.textContent?.trim() || '';
              break;
            }
          }
        }
      } catch(e) {}

      // --- Lematización y filtrado como en construirTablaSecuencia.js ---
      function filtrarYLematizar(texto) {
        if (!texto) return '';
        const articulos = ["el","la","los","las","un","una","unos","unas"];
        const preposiciones = ["a","ante","bajo","cabe","con","contra","de","desde","en","entre","hacia","hasta","para","por","según","sin","so","sobre","tras"];
        const pronombres = ["yo","tú","él","ella","nosotros","vosotros","ellos","ellas","me","te","se","nos","os","mi","tu","su","nuestro","vuestro","sus","le","les"];
        const auxiliaresYModales = ["he","has","ha","hemos","habéis","han","hube","hubiste","hubo","hubimos","hubisteis","hubieron","había","habías","habíamos","habíais","habían","habré","habrás","habrá","habremos","habréis","habrán","habría","habrías","habríamos","habríais","habrían","soy","eres","es","somos","sois","son","era","eras","éramos","erais","eran","seré","serás","será","seremos","seréis","serán","sería","serías","seríamos","seríais","serían","estoy","estás","está","estamos","estáis","están","estuve","estuviste","estuvo","estuvimos","estuvisteis","estuvieron","estaba","estabas","estábamos","estabais","estaban","estaré","estarás","estará","estaremos","estaréis","estarán","estaría","estarías","estaríamos","estaríais","estarían","tengo","tienes","tiene","tenemos","tenéis","tienen","tuve","tuviste","tuvo","tuvimos","tuvisteis","tuvieron","tenía","tenías","teníamos","teníais","tenían","tendré","tendrás","tendrá","tendremos","tendréis","tendrán","tendría","tendrías","tendríamos","tendríais","tendrían"];
        const lemas = {
          "realizando": "realizar", "realizaron": "realizar", "realizó": "realizar", "realiza": "realizar", "realizar": "realizar",
          "momento": "momento", "momentos": "momento", "estrategias": "estrategia", "estrategia": "estrategia",
          "materiales": "material", "material": "material", "herramientas": "herramienta", "herramienta": "herramienta",
          "lecturas": "lectura", "lectura": "lectura", "recomendadas": "recomendar", "recomendada": "recomendar",
          "ejecutar": "ejecutar", "ejecución": "ejecutar", "aplicar": "aplicar", "aplicación": "aplicar",
          "fase": "fase", "etapa": "etapa", "tiempo": "tiempo", "espacio": "espacio", "minutos": "minuto", "minuto": "minuto"
        };
        const stopwords = new Set([
          ...articulos,
          ...preposiciones,
          ...pronombres,
          ...auxiliaresYModales
        ]);
        return texto
          .toLowerCase()
          .replace(/[.,;:()¿?!¡"]/g, "")
          .split(/\s+/)
          .filter(palabra => !stopwords.has(palabra))
          .map(palabra => lemas[palabra] || palabra)
          .join(" ");
      }
      // --- Filtrado avanzado como en construirTablaSecuencia.js ---
      function filtrarYLematizarAvanzado(texto) {
        if (!texto) return '';
        const articulos = ["el","la","los","las","un","una","unos","unas"];
        const preposiciones = ["a","ante","bajo","cabe","con","contra","de","desde","en","entre","hacia","hasta","para","por","según","sin","so","sobre","tras"];
        const pronombres = ["yo","tú","él","ella","nosotros","vosotros","ellos","ellas","me","te","se","nos","os","mi","tu","su","nuestro","vuestro","sus","le","les"];
        const auxiliaresYModales = ["ser","estar","haber","tener","poder","deber","querer","ir","venir","ver","dar","decir","hacer","gustar","soler"];
        const conectores = ["y","o","u","e","pero","aunque","sino","también","además","incluso","solo","sólo","ya","aquí","allí","así","cada","otro","otra","otros","otras","más","menos","muy","poco","mucho","casi","siempre","nunca","antes","después","nuevo","nueva","nuevos","nuevas"];
        const lemas = {
          "problema": "problema",
          "manera": "modo",
          "forma": "modo",
          "eficiente": "eficiente",
          "eficiencia": "eficiente",
          "cultivos": "cultivo",
          "recursos": "recurso",
          "zonas": "zona",
          "lugares": "lugar",
          "región": "región",
          "anual": "anual"
        };
        const stopwords = new Set([
          ...articulos,
          ...preposiciones,
          ...pronombres,
          ...auxiliaresYModales,
          ...conectores
        ]);
        const palabras = texto
          .toLowerCase()
          .replace(/[.,;:()¿?!¡"\d]/g, "")
          .split(/\s+/)
          .filter(palabra => palabra.length > 2 && !stopwords.has(palabra));
        const lematizadas = palabras.map(palabra => lemas[palabra] || palabra);
        return [...new Set(lematizadas)].join(" ");
      }
      // Construir prompt optimizado y específico
      const prompt = `Eres experto en didáctica. Dame solo los materiales y herramientas muy específicos y concretos necesarios para ejecutar la siguiente actividad, considerando el contexto didáctico. Responde solo con una lista breve, sin explicaciones ni repeticiones.\nActividad: ${filtrarYLematizarAvanzado(momentoText)}\nEstrategia: ${filtrarYLematizarAvanzado(estrategia)}\nFase: ${filtrarYLematizarAvanzado(fase)}${etapa ? `\nEtapa: ${filtrarYLematizarAvanzado(etapa)}` : ''}\nTiempo: ${filtrarYLematizarAvanzado(tiempo)} min\nEspacio: ${filtrarYLematizarAvanzado(espacio)}`;
      // Solo premium puede usar IA
      if (typeof isPremiumUser === 'function' && !isPremiumUser()) {
        if (typeof mostrarMensajeSoloPremium === 'function') mostrarMensajeSoloPremium();
        mediosInput.value = 'Solo usuarios premium pueden usar la IA.';
        recycleBtn.textContent = '♻️';
        recycleBtn.disabled = false;
        return;
      }
      // Descontar crédito antes de la solicitud IA
      try {
        if (typeof descontarCreditoUsuario === 'function') {
          const creditosRestantes = await descontarCreditoUsuario();
          if (creditosRestantes <= 0) {
            mediosInput.value = 'Sin créditos disponibles.';
            recycleBtn.textContent = '♻️';
            recycleBtn.disabled = false;
            alert('No tienes créditos disponibles para solicitar a la IA.');
            return;
          }
        }
        const res = await fetch('/api/ia/generatePlan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ prompt: prompt, max_tokens: 120 })
        });
        if (!res.ok) throw new Error('Error IA: ' + res.statusText);
        const data = await res.json();
        let txt = data.response || data.result || data.choices?.[0]?.text || JSON.stringify(data);
        mediosInput.value = txt.trim();
        autoGrowTextarea(mediosInput);
      } catch(e) {
        mediosInput.value = 'Error al generar materiales: ' + (e.message||e);
      }
      recycleBtn.textContent = '♻️';
      recycleBtn.disabled = false;
      saveOrganizacionRows();
    };
    // Right-click: show recycle menu
    recycleBtn.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      showRecycleMenu(e, mediosInput);
    });
    mediosTd.appendChild(recycleBtn);
    tr.appendChild(mediosTd);
    // Acciones
    const accionesTd = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = 'Eliminar';
    delBtn.className = 'add-alumnos-btn';
    delBtn.style.background = '#dc3545';
    delBtn.onclick = function() {
      // Obtener el índice real de la fila en el DOM
      const trElement = this.closest('tr');
      const tbody = trElement.parentNode;
      const rowIndex = Array.from(tbody.children).indexOf(trElement);
      // Obtener los datos actuales desde localStorage (siempre la fuente de verdad)
      let currentRows = [];
      try { currentRows = JSON.parse(localStorage.getItem('organizacionRows')) || []; } catch(e) { currentRows = []; }
      // Eliminar la fila correspondiente
      currentRows.splice(rowIndex, 1);
      // Guardar y volver a renderizar
      localStorage.setItem('organizacionRows', JSON.stringify(currentRows));
      renderOrganizacionTable(currentRows);
    };
    accionesTd.appendChild(delBtn);
    tr.appendChild(accionesTd);
    tbody.appendChild(tr);
  });
}

function saveOrganizacionRows() {
  const tbody = document.getElementById('organizacionTableBody');
  const rows = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const fase = tr.querySelector('.fase-select')?.value || '';
    const etapa = tr.querySelector('.etapa-col select')?.value || '';
    const tiempo = tr.querySelector('td:nth-child(3) input')?.value || '';
    const espacio = tr.querySelector('td:nth-child(4) select')?.value || '';
    const medios = tr.querySelector('td:nth-child(5) textarea')?.value || '';
    if (medios && !mediosRecyclingList.includes(medios)) mediosRecyclingList.push(medios);
    rows.push({ Fase: fase, Etapa: etapa, Tiempo: tiempo, Espacio: espacio, Medios: medios });
  });
  localStorage.setItem('organizacionRows', JSON.stringify(rows));
}

function loadOrganizacionRows() {
  let rows = [];
  try {
    rows = JSON.parse(localStorage.getItem('organizacionRows')) || [];
  } catch(e) { rows = []; }
  renderOrganizacionTable(rows);
}

function showRecycleMenu(e, inputEl) {
  e.stopPropagation();
  const menu = document.getElementById('recycleMediosMenu');
  menu.innerHTML = '';
  mediosRecyclingList.filter(m => m).forEach(m => {
    const item = document.createElement('div');
    item.textContent = m;
    item.style.padding = '6px 12px';
    item.style.cursor = 'pointer';
    item.onclick = () => { inputEl.value = m; saveOrganizacionRows(); menu.style.display = 'none'; };
    menu.appendChild(item);
  });
  if (menu.innerHTML === '') {
    const none = document.createElement('div');
    none.textContent = 'No hay recursos previos';
    none.style.padding = '6px 12px';
    menu.appendChild(none);
  }
  menu.style.display = 'block';
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
}
document.body.addEventListener('click', () => {
  document.getElementById('recycleMediosMenu').style.display = 'none';
});

document.getElementById('addOrganizacionRowBtn').onclick = function() {
  let rows = [];
  try { rows = JSON.parse(localStorage.getItem('organizacionRows')) || []; } catch(e){}
  rows.push({ Fase: '', Etapa: '', Tiempo: '', Espacio: '', Medios: '' });
  localStorage.setItem('organizacionRows', JSON.stringify(rows));
  renderOrganizacionTable(rows);
};

// On DOMContentLoaded, load rows and update on methodology/secuencia changes
window.addEventListener('DOMContentLoaded', () => {
  // Medios recycling list
  try { mediosRecyclingList = JSON.parse(localStorage.getItem('mediosRecyclingList')) || []; } catch(e){}
  loadOrganizacionRows();
  // Listen for changes to metodologia or secuencia
  const metoElem = document.getElementById('metodologia');
  if (metoElem) {
    const observer = new MutationObserver(() => {
      getSecuenciaFasesEtapas();
      let rows = [];
      try { rows = JSON.parse(localStorage.getItem('organizacionRows')) || []; } catch(e){}
      renderOrganizacionTable(rows);
    });
    observer.observe(metoElem, { childList: true, subtree: true, characterData: true });
  }
  // Save medios recycling list on unload
  window.addEventListener('beforeunload', () => {
    localStorage.setItem('mediosRecyclingList', JSON.stringify(mediosRecyclingList));
  });
});

// Update savePlan and loadTablesData to include organizacionRows
const originalSavePlan = window.savePlan;
window.savePlan = function() {
  saveOrganizacionRows();
  if (originalSavePlan) originalSavePlan();
};
const originalLoadTablesData = window.loadTablesData;
window.loadTablesData = function(data) {
  if (originalLoadTablesData) originalLoadTablesData(data);
  if (data && data.organizacion) {
    localStorage.setItem('organizacionRows', JSON.stringify(data.organizacion));
    renderOrganizacionTable(data.organizacion);
  }
};
// --- END ORGANIZACIÓN TABLE LOGIC ---

</script>
<script src="construirTablaSecuencia.js"></script>
<script>
// --- Exportar e importar el plan completo como JSON ---
function updatePlanViewerDataRaw() {
  // Igual que exportPlanJSON pero solo actualiza el textarea
  const editables = Array.from(document.querySelectorAll('.editable[contenteditable="true"]'));
  const editableData = {};
  editables.forEach(elem => {
    const key = getCellKey(elem);
    if (key) editableData[key] = elem.innerHTML;
  });
  let organizacionRows = [];
  try { organizacionRows = JSON.parse(localStorage.getItem('organizacionRows')) || []; } catch(e){}
  let mediosRecyclingList = [];
  try { mediosRecyclingList = JSON.parse(localStorage.getItem('mediosRecyclingList')) || []; } catch(e){}
  const plan = {
    editables: editableData,
    organizacion: organizacionRows,
    mediosRecyclingList
  };
  const raw = document.getElementById('planViewerDataRaw');
  if (raw) raw.value = JSON.stringify(plan, null, 2);
}
function exportPlanJSON() {
  // 1. Celdas editables
  const editables = Array.from(document.querySelectorAll('.editable[contenteditable="true"]'));
  const editableData = {};
  editables.forEach(elem => {
    const key = getCellKey(elem);
    if (key) editableData[key] = elem.innerHTML;
  });
  // 2. Organización
  let organizacionRows = [];
  try { organizacionRows = JSON.parse(localStorage.getItem('organizacionRows')) || []; } catch(e){}
  // 3. Medios reciclados (si aplica)
  let mediosRecyclingList = [];
  try { mediosRecyclingList = JSON.parse(localStorage.getItem('mediosRecyclingList')) || []; } catch(e){}
  // 4. Otros datos relevantes (agrega aquí si necesitas más)
  // 5. Empaquetar
  const plan = {
    editables: editableData,
    organizacion: organizacionRows,
    mediosRecyclingList
  };
  const blob = new Blob([JSON.stringify(plan, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'plan-didactico.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); }, 100);
  updatePlanViewerDataRaw();
}

function importPlanJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const plan = JSON.parse(e.target.result);
      // 1. Restaurar celdas editables
      if (plan.editables) {
        for (const [key, value] of Object.entries(plan.editables)) {
          // Buscar el elemento por key
          const selector = key.startsWith('plano_') ? `[id="${key.replace('plano_','')}"]` : '';
          let elem = null;
          if (selector) elem = document.querySelector(selector);
          if (!elem) {
            // Buscar por tabla+fila+columna
            const parts = key.split('_');
            if (parts.length >= 4) {
              const tableId = parts[1];
              const rowIdx = parseInt(parts[2]);
              const colIdx = parseInt(parts[3]);
              const table = document.getElementById(tableId);
              if (table && table.rows && table.rows[rowIdx] && table.rows[rowIdx].children[colIdx]) {
                elem = table.rows[rowIdx].children[colIdx];
              }
            }
          }
          if (elem && elem.classList.contains('editable') && elem.isContentEditable) {
            elem.innerHTML = value;
            localStorage.setItem(key, value);
          }
        }
      }
      // 2. Organización
      if (plan.organizacion) {
        localStorage.setItem('organizacionRows', JSON.stringify(plan.organizacion));
        if (typeof renderOrganizacionTable === 'function') renderOrganizacionTable(plan.organizacion);
      }
      // 3. Medios reciclados
      if (plan.mediosRecyclingList) {
        localStorage.setItem('mediosRecyclingList', JSON.stringify(plan.mediosRecyclingList));
      }
      // 4. Refrescar persistencia visual
      restoreEditableCells();
      if (typeof restoreInputCells === 'function') restoreInputCells();
      alert('Plan cargado correctamente.');
      updatePlanViewerDataRaw();
    } catch(e) {
      alert('Error al cargar el plan: ' + e.message);
    }
  };
  reader.readAsText(file);
}
// Persistencia para todas las celdas editables (datos generales, tablas, etc)
function getCellKey(elem) {
  // Usa id si existe, si no, genera con tabla+fila+columna
  if (elem.id) return 'plano_' + elem.id;
  let parentRow = elem.closest('tr');
  let table = elem.closest('table');
  if (!parentRow || !table) return null;
  let rowIdx = Array.from(parentRow.parentNode.children).indexOf(parentRow);
  let colIdx = Array.from(parentRow.children).indexOf(elem);
  let tableId = table.id || table.parentNode.id || 'tabla';
  return `plano_${tableId}_${rowIdx}_${colIdx}`;
}
function saveEditableCell(e) {
  const elem = e.target;
  const key = getCellKey(elem);
  if (key) localStorage.setItem(key, elem.innerHTML);
}
function restoreEditableCells() {
  document.querySelectorAll('.editable[contenteditable="true"]').forEach(elem => {
    // NO editar nombreProyecto ni metodologia
    if (elem.id === 'nombreProyecto' || elem.id === 'metodologia' || elem.classList.contains('no-edit')) {
      elem.removeAttribute('contenteditable');
      elem.classList.remove('editable');
      return;
    }
    const key = getCellKey(elem);
    if (key && localStorage.getItem(key) !== null) {
      elem.innerHTML = localStorage.getItem(key);
    }
    elem.addEventListener('input', function(e) {
      saveEditableCell(e);
      updatePlanViewerDataRaw();
    });
    elem.addEventListener('blur', function(e) {
      saveEditableCell(e);
      updatePlanViewerDataRaw();
    });
  });
}
window.addEventListener('DOMContentLoaded', function() {
  restoreEditableCells();
  updatePlanViewerDataRaw();
});
// Si se agregan filas dinámicamente en tablas, llamar a restoreEditableCells tras agregarlas.
</script>
<script>
// Auto-grow para textareas de momentos
function autoGrowTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = (textarea.scrollHeight) + 'px';
}
document.addEventListener('input', function(e) {
  if (e.target && e.target.matches('textarea.auto-grow')) {
    autoGrowTextarea(e.target);
  }
});
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('textarea.auto-grow').forEach(function(t) {
    autoGrowTextarea(t);
  });
});
</script>
</html>